<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.simpol.polisight.mapper.MemberMapper">

    <insert id="insertMember" parameterType="com.simpol.polisight.dto.MemberDto">
        INSERT INTO member (
        email, passwordHash, memberName, birthDate, provider, gender,
        province, city, personalIncome, familyIncome, familySize, child,
        eduLevelCode, empStatusCode, married, home, businessRegistered,
        createdAt, updatedAt
        ) VALUES (
        #{email}, #{passwordHash}, #{memberName}, #{birthDate}, #{provider}, #{gender},
        #{province}, #{city}, #{personalIncome}, #{familyIncome}, #{familySize}, #{child},
        #{eduLevelCode}, #{empStatusCode}, #{married}, #{home}, #{businessRegistered},
        NOW(), NOW() )
    </insert>

    <select id="selectMemberByEmail" parameterType="string" resultType="com.simpol.polisight.dto.MemberDto">
        SELECT
        m.*,
        -- 화면용 필드에 DB 값 매핑 (조회 시 필요)
        province AS regionSi,
        city AS regionGu,
        eduLevelCode AS educationLevel,
        empStatusCode AS employmentStatus,
        businessRegistered AS isBusinessOwner,

        -- Boolean -> String 변환 (선택 사항, 화면 로직에 따라 다름)
        -- 여기서는 기본 필드(married, home)에 Boolean 값이 자동으로 들어감
        married, home
        FROM member m
        WHERE email = #{email}
    </select>

    <update id="updateMember" parameterType="com.simpol.polisight.dto.MemberDto">
        UPDATE member
        SET
        memberName = #{memberName},
        birthDate = #{birthDate},
        updatedAt = NOW()
        <if test="passwordHash != null and passwordHash != ''">
            , passwordHash = #{passwordHash}
        </if>
        WHERE email = #{email}
    </update>

    <update id="updateConditions" parameterType="com.simpol.polisight.dto.MemberDto">
        UPDATE member
        SET
        updatedAt = NOW()

        -- 지역
        <if test="regionSi != null">, province = #{regionSi}</if>
        <if test="regionGu != null">, city = #{regionGu}</if>

        -- 기본 정보
        <if test="gender != null">, gender = #{gender}</if>
        <if test="birthDate != null">, birthDate = #{birthDate}</if>

        -- 소득 및 가족
        <if test="personalIncome != null">, personalIncome = #{personalIncome}</if>
        <if test="familyIncome != null">, familyIncome = #{familyIncome}</if>
        <if test="familySize != null">, familySize = #{familySize}</if>
        <if test="child != null">, child = #{child}</if>

        -- 상태 코드 (화면 필드명 -> DB 컬럼)
        <if test="educationLevel != null">, eduLevelCode = #{educationLevel}</if>
        <if test="employmentStatus != null">, empStatusCode = #{employmentStatus}</if>

        -- 사업자 여부 (화면 isBusinessOwner -> DB businessRegistered)
        <if test="isBusinessOwner != null">, businessRegistered = #{isBusinessOwner}</if>

        -- 결혼/주택 (DTO의 married, home 필드가 Boolean으로 잘 넘어오면 그대로 사용)
        -- 화면에서 'Y'/'N' 문자열로 보낸다면 marryStatus 사용 필요
        -- 여기서는 Controller/JS에서 Boolean으로 처리한다고 가정하고 married 사용
        <if test="married != null">, married = #{married}</if>
        <if test="home != null">, home = #{home}</if>

        WHERE email = #{email}
    </update>

    <select id="countByEmail" parameterType="String" resultType="int">
        SELECT COUNT(*) FROM member WHERE email = #{email}
    </select>

    <update id="updatePassword">
        UPDATE member SET passwordHash = #{passwordHash} WHERE email = #{email}
    </update>

</mapper>