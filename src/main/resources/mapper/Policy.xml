<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.simpol.polisight.mapper.PolicyMapper">

    <resultMap id="PolicyResultMap" type="com.simpol.polisight.dto.PolicyDto">
        <id property="plcyNo" column="plcyNo"/>
        <result property="plcyNm" column="plcyNm"/>
        <result property="plcyExplnCn" column="plcyExplnCn"/>
        <result property="lclsfNm" column="lclsfNm"/>
        <result property="bizPrdBgngYmd" column="bizPrdBgngYmd"/>
        <result property="bizPrdEndYmd" column="bizPrdEndYmd"/>

        <result property="aplyPrdSeCd" column="aplyPrdSeCd"
                typeHandler="com.simpol.polisight.handler.CodeEnumTypeHandler"
                javaType="com.simpol.polisight.type.AplyPrdType"/>

        <result property="bizPrdSeCd" column="bizPrdSeCd"
                typeHandler="com.simpol.polisight.handler.CodeEnumTypeHandler"
                javaType="com.simpol.polisight.type.BizPrdType"/>

        <result property="mrgSttsCd" column="mrgSttsCd"
                typeHandler="com.simpol.polisight.handler.CodeEnumTypeHandler"
                javaType="com.simpol.polisight.type.MrgSttsType"/>

        <result property="earnCndSeCd" column="earnCndSeCd"
                typeHandler="com.simpol.polisight.handler.CodeEnumTypeHandler"
                javaType="com.simpol.polisight.type.EarnCndType"/>

        <result property="plcyMajorCd" column="plcyMajorCd"
                typeHandler="com.simpol.polisight.handler.JsonListTypeHandler"
                javaType="com.simpol.polisight.type.MajorType"/>

        <result property="jobCd" column="jobCd"
                typeHandler="com.simpol.polisight.handler.JsonListTypeHandler"
                javaType="com.simpol.polisight.type.JobType"/>

        <result property="schoolCd" column="schoolCd"
                typeHandler="com.simpol.polisight.handler.JsonListTypeHandler"
                javaType="com.simpol.polisight.type.SchoolType"/>

        <result property="sbizCd" column="sbizCd"
                typeHandler="com.simpol.polisight.handler.JsonListTypeHandler"
                javaType="com.simpol.polisight.type.SbizType"/>
    </resultMap>

    <select id="selectPoliciesByCondition"
            parameterType="com.simpol.polisight.dto.PolicySearchCondition"
            resultMap="PolicyResultMap">
        SELECT
        p.plcyNo,
        p.plcyNm,
        p.plcyExplnCn,
        p.lclsfNm,
        p.bizPrdBgngYmd,
        p.bizPrdEndYmd,
        -- [NEW] 새로 추가된 컬럼들을 반드시 SELECT 절에 포함해야 ResultMap이 작동합니다.
        p.aplyPrdSeCd,
        p.bizPrdSeCd,
        p.mrgSttsCd,
        p.earnCndSeCd,
        p.plcyMajorCd,
        p.jobCd,
        p.schoolCd,
        p.sbizCd
        FROM policy p
        <where>
            <if test="keyword != null and keyword != ''">
                AND (
                p.plcyNm LIKE CONCAT('%', #{keyword}, '%')
                OR p.plcyExplnCn LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>

            <if test="regionSi != null and regionSi != ''">
                AND (
                EXISTS (
                SELECT 1
                FROM region r
                WHERE r.province = #{regionSi}
                <if test="regionGu != null and regionGu != ''">
                    AND r.city = #{regionGu}
                </if>
                AND JSON_CONTAINS(p.zipCd, CAST(CONCAT('"', r.zipCd, '"') AS JSON))
                )
                OR p.zipCd IS NULL
                OR JSON_LENGTH(p.zipCd) = 0
                )
            </if>

            <if test="age != null">
                AND (p.sprtTrgtMinAge IS NULL OR p.sprtTrgtMinAge &lt;= #{age})
                AND (p.sprtTrgtMaxAge IS NULL OR p.sprtTrgtMaxAge &gt;= #{age})
            </if>

            <if test="income != null">
                AND (p.earnMaxAmt IS NULL OR p.earnMaxAmt >= #{income})
            </if>

            <if test="educationLevel != null and educationLevel.size > 0">
                AND (
                p.schoolCd IS NULL

                -- [필수 포함 1] 기타 (0049009)
                OR JSON_SEARCH(p.schoolCd, 'one', '0049009') IS NOT NULL

                -- [필수 포함 2] 제한없음 (0049010)
                OR JSON_SEARCH(p.schoolCd, 'one', '0049010') IS NOT NULL

                -- [사용자 선택 값] (예: 고교 졸업 등)
                OR
                <foreach collection="educationLevel" item="item" open="(" close=")" separator=" OR ">
                    JSON_SEARCH(p.schoolCd, 'one', #{item}) IS NOT NULL
                </foreach>
                )
            </if>

            <if test="employmentStatus != null and employmentStatus.size > 0">
                AND (
                p.jobCd IS NULL

                -- [무조건 포함] 기타(0013009) + 제한없음(0013010)
                OR JSON_SEARCH(p.jobCd, 'one', '0013009') IS NOT NULL
                OR JSON_SEARCH(p.jobCd, 'one', '0013010') IS NOT NULL

                -- [사용자 선택 값] (Service에서 확장된 코드들: 재직자, 일용직 등)
                OR
                <foreach collection="employmentStatus" item="item" open="(" close=")" separator=" OR ">
                    JSON_SEARCH(p.jobCd, 'one', #{item}) IS NOT NULL
                </foreach>
                )
            </if>

            <if test="marry != null and marry != ''">
                AND (
                -- 1. [내 선택] Service에서 변환된 코드 (기혼:0055001 또는 미혼:0055002)가 포함된 정책
                p.mrgSttsCd LIKE CONCAT('%', #{marry}, '%')

                -- 2. [공통] '제한없음(0055003)' 코드가 포함된 정책 (누구나 가능)
                OR p.mrgSttsCd LIKE '%0055003%'

                -- 3. [공통] 결혼 조건 데이터가 아예 없는 정책 (보통 누구나 가능)
                OR p.mrgSttsCd IS NULL
                OR p.mrgSttsCd = ''
                )
            </if>

            AND (p.bizPrdEndYmd IS NULL OR p.bizPrdEndYmd >= CURDATE())
        </where>

        ORDER BY
        CASE WHEN p.bizPrdEndYmd IS NULL THEN 1 ELSE 0 END,
        p.bizPrdEndYmd ASC
    </select>

    <select id="selectPolicyById" resultMap="PolicyResultMap">
        SELECT
        plcyNo,
        plcyNm,
        plcyExplnCn,
        lclsfNm,
        bizPrdBgngYmd,
        bizPrdEndYmd,
        -- [NEW] 여기서도 새 컬럼들을 조회해야 상세 페이지에서 정보를 볼 수 있습니다.
        aplyPrdSeCd,
        bizPrdSeCd,
        mrgSttsCd,
        earnCndSeCd,
        plcyMajorCd,
        jobCd,
        schoolCd,
        sbizCd
        FROM policy
        WHERE plcyNo = #{id}
    </select>

</mapper>