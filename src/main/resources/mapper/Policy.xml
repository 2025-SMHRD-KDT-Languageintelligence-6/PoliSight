<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.simpol.polisight.mapper.PolicyMapper">

    <resultMap id="PolicyResultMap" type="com.simpol.polisight.dto.PolicyDto">
        <id property="plcyNo" column="plcyNo"/>
        <result property="plcyNm" column="plcyNm"/>
        <result property="plcyExplnCn" column="plcyExplnCn"/>
        <result property="lclsfNm" column="lclsfNm"/>
        <result property="bizPrdBgngYmd" column="bizPrdBgngYmd"/>
        <result property="bizPrdEndYmd" column="bizPrdEndYmd"/>
    </resultMap>

    <select id="selectPoliciesByCondition"
            parameterType="com.simpol.polisight.dto.PolicySearchCondition"
            resultMap="PolicyResultMap"> SELECT
        p.plcyNo,
        p.plcyNm,
        p.plcyExplnCn,
        p.lclsfNm,
        p.bizPrdBgngYmd,
        p.bizPrdEndYmd
        FROM policy p
        <where>
            <if test="keyword != null and keyword != ''">
                AND (
                p.plcyNm LIKE CONCAT('%', #{keyword}, '%')
                OR p.plcyExplnCn LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>

            <if test="regionSi != null and regionSi != ''">
                AND (
                -- A. 특정 지역 매칭 (EXISTS 서브쿼리 사용)
                EXISTS (
                SELECT 1
                FROM region r
                WHERE r.province = #{regionSi}  <if test="regionGu != null and regionGu != ''">
                AND r.city = #{regionGu}    </if>
                -- 정책의 JSON 배열에 지역 코드가 포함되어 있는지 확인
                AND JSON_CONTAINS(p.zipCd, CAST(CONCAT('"', r.zipCd, '"') AS JSON))
                )
                -- B. 혹은 '전국' 대상 정책 (zipCd가 NULL이거나 비어있으면 전국으로 간주하는 경우)
                OR p.zipCd IS NULL
                OR JSON_LENGTH(p.zipCd) = 0
                )
            </if>

            <if test="age != null">
                AND (p.sprtTrgtMinAge IS NULL OR p.sprtTrgtMinAge &lt;= #{age})
                AND (p.sprtTrgtMaxAge IS NULL OR p.sprtTrgtMaxAge &gt;= #{age})
            </if>

            <if test="income != null">
                AND (p.earnMaxAmt IS NULL OR p.earnMaxAmt >= #{income})
            </if>

            <if test="educationLevel != null and educationLevel != ''">
                AND (p.schoolCd IS NULL OR JSON_SEARCH(p.schoolCd, 'one', #{educationLevel}) IS NOT NULL)
            </if>
            <if test="employmentStatus != null and employmentStatus != ''">
                AND (p.jobCd IS NULL OR JSON_SEARCH(p.jobCd, 'one', #{employmentStatus}) IS NOT NULL)
            </if>

            AND (p.bizPrdEndYmd IS NULL OR p.bizPrdEndYmd >= CURDATE())
        </where>

        ORDER BY
        CASE WHEN p.bizPrdEndYmd IS NULL THEN 1 ELSE 0 END,
        p.bizPrdEndYmd ASC
    </select>

    <select id="selectPolicyById" resultMap="PolicyResultMap">
        SELECT
        plcyNo,
        plcyNm,
        plcyExplnCn,
        lclsfNm,
        bizPrdBgngYmd,
        bizPrdEndYmd
        FROM policy
        WHERE plcyNo = #{id}
    </select>

</mapper>