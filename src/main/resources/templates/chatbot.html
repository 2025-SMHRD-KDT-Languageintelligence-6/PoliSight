<div th:fragment="chatbot">

    <th:block th:if="${session.loginMember != null}">

        <link rel="stylesheet" th:href="@{/css/chatbot.css}">

        <div id="chatbot-container">
            <button id="chatbot-toggle-btn" aria-label="ì±—ë´‡ ì—´ê¸°">
                <img class="chatbot-icon-img" th:src="@{/image/chatbot_icon.png}" alt="PoliSight ì±—ë´‡ ì•„ì´ì½˜">
            </button>

            <div id="chatbot-window">
                <div class="chatbot-header">
                    <span>PoliSight AI ì•ˆë‚´ì›</span>
                    <button id="chatbot-close-btn">&times;</button>
                </div>

                <div id="chatbot-messages">
                    <div class="message bot-message">
                        ì•ˆë…•í•˜ì„¸ìš” ğŸ˜Š<br>
                        ì •ì±… ê²€ìƒ‰ì´ë‚˜ ì‹œë®¬ë ˆì´ì…˜ ê´€ë ¨í•´ì„œ<br>
                        ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”!
                    </div>
                </div>

                <div class="chatbot-input-area">
                    <input type="text" id="chatbot-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">
                    <button id="chatbot-send-btn">ì „ì†¡</button>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const toggleBtn = document.getElementById('chatbot-toggle-btn');
                const closeBtn = document.getElementById('chatbot-close-btn');
                const chatWindow = document.getElementById('chatbot-window');
                const sendBtn = document.getElementById('chatbot-send-btn');
                const input = document.getElementById('chatbot-input');
                const messages = document.getElementById('chatbot-messages');

                if (!toggleBtn || !chatWindow) return;

                toggleBtn.addEventListener('click', () => {
                    chatWindow.classList.toggle('visible');
                    if (chatWindow.classList.contains('visible')) {
                        setTimeout(() => input.focus(), 100);
                    }
                });

                closeBtn.addEventListener('click', () => {
                    chatWindow.classList.remove('visible');
                });

                function sendMessage() {
                    const text = input.value.trim();
                    if (!text) return;

                    addMessage(text, 'user-message');
                    input.value = '';

                    // ì„ì‹œ ì‘ë‹µ (ì¶”í›„ Live2D ì—°ë™ ì‹œ ë¡œì§ ë³€ê²½ ê°€ëŠ¥)
                    setTimeout(() => {
                        addMessage("í™•ì¸í–ˆìŠµë‹ˆë‹¤ ğŸ‘\nê³§ ì •ì±… ì¡°ê±´ì— ë§ì¶° ì•ˆë‚´í•´ ë“œë¦´ê²Œìš”.", 'bot-message');
                    }, 600);
                }

                sendBtn.addEventListener('click', sendMessage);
                input.addEventListener('keypress', e => {
                    if (e.key === 'Enter') sendMessage();
                });

                function addMessage(text, type) {
                    const div = document.createElement('div');
                    div.className = `message ${type}`;
                    div.textContent = text;
                    messages.appendChild(div);
                    messages.scrollTop = messages.scrollHeight;
                }
            });
        </script>

    </th:block>
</div>