<div th:fragment="chatbot" xmlns:th="http://www.w3.org/1999/xhtml">

    <th:block th:if="${session.loginMember != null}">

        <link rel="stylesheet" th:href="@{/css/chatbot.css}">

        <script th:src="@{/live2d/live2dcubismcore.min.js}"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.10/browser/pixi.min.js"></script>
        <script>window.PIXI = PIXI;</script>
        <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/cubism4.min.js"></script>

        <style>
            #live2d-loading {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
                color: #555;
                font-size: 14px;
                display: none; /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
                z-index: 10;
                width: 100%;
            }
            .loading-spinner {
                display: inline-block;
                width: 24px;
                height: 24px;
                border: 3px solid rgba(0, 0, 0, 0.1);
                border-radius: 50%;
                border-top-color: #333;
                animation: spin 1s ease-in-out infinite;
                margin-bottom: 8px;
            }
            @keyframes spin { to { transform: rotate(360deg); } }
        </style>

        <div id="chatbot-container">
            <button id="chatbot-toggle-btn" aria-label="ì±—ë´‡ ì—´ê¸°">
                <img class="chatbot-icon-img" th:src="@{/image/chatbot_icon.png}" alt="PoliSight ì±—ë´‡ ì•„ì´ì½˜">
            </button>

            <div id="chatbot-window">

                <div id="live2d-stage">
                    <canvas id="live2d-canvas"></canvas>

                    <div id="live2d-loading">
                        <div class="loading-spinner"></div>
                        <div>Liaê°€ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤...<br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
                    </div>
                </div>

                <div id="chatbot-right-panel">
                    <div class="chatbot-header">
                        <span>AI ì •ì±… ì „ë¬¸ê°€ ë¦¬ì•„</span>
                        <button id="chatbot-close-btn">&times;</button>
                    </div>

                    <div id="chatbot-messages">
                        <div class="message bot-message">
                            ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š<br>
                            AI ì •ì±… ì „ë¬¸ê°€ ë¦¬ì•„ì…ë‹ˆë‹¤!<br>
                            ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë´ ì£¼ì„¸ìš”.
                        </div>
                    </div>

                    <div class="chatbot-input-area">
                        <input type="text" id="chatbot-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">
                        <button id="chatbot-send-btn">ì „ì†¡</button>
                    </div>
                </div>

            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const toggleBtn = document.getElementById('chatbot-toggle-btn');
                const closeBtn = document.getElementById('chatbot-close-btn');
                const chatWindow = document.getElementById('chatbot-window');
                const sendBtn = document.getElementById('chatbot-send-btn');
                const input = document.getElementById('chatbot-input');
                const messages = document.getElementById('chatbot-messages');

                const live2dCanvas = document.getElementById('live2d-canvas');
                const stage = document.getElementById('live2d-stage');
                const loadingDiv = document.getElementById('live2d-loading');

                let app = null;
                let model = null;
                let initialized = false;
                let isLoading = false;

                // [ì¶”ê°€ë¨] ì• ë‹ˆë©”ì´ì…˜ ì¤‘ë³µ ë°©ì§€ìš© í”Œë˜ê·¸ (Lock)
                let isMotionPlaying = false;

                // ë§ˆìš°ìŠ¤ ì¶”ì  ì œì–´ìš© í”Œë˜ê·¸
                let isTrackingSuspended = false;

                if (!toggleBtn || !chatWindow) return;

                // ================= UI ì´ë²¤íŠ¸ =================
                toggleBtn.addEventListener('click', async () => {
                    chatWindow.classList.toggle('visible');

                    if (chatWindow.classList.contains('visible')) {
                        setTimeout(() => input?.focus(), 100);

                        if (!initialized && !isLoading) {
                            isLoading = true;
                            if(loadingDiv) loadingDiv.style.display = 'block';

                            await initLive2D();

                            if(loadingDiv) loadingDiv.style.display = 'none';

                            initialized = true;
                            isLoading = false;

                            // ë¡œë”© ì§í›„ ëª¨ì…˜ ì‹¤í–‰
                            setTimeout(() => {
                                playHelloMotion();
                            }, 200);

                        } else if (initialized) {
                            setTimeout(() => resizeLive2D(), 50);

                            // ì°½ì„ ë‹¤ì‹œ ì—´ì—ˆì„ ë•Œë„ ëª¨ì…˜ ì‹¤í–‰
                            setTimeout(() => {
                                playHelloMotion();
                            }, 200);
                        }
                    }
                });

                closeBtn?.addEventListener('click', () => {
                    chatWindow.classList.remove('visible');
                });

                async function sendMessage() {
                    const text = input.value.trim();
                    if (!text) return;

                    addMessage(text, 'user-message');
                    input.value = '';

                    try {
                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ user_input: text })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            addMessage(data.answer, 'bot-message');

                            // ë¶€ì •ì /ì‚¬ê³¼ í‚¤ì›Œë“œ ì •ì˜
                            const negativeKeywords = [
                                "ì£„ì†¡", "ë¯¸ì•ˆ", "ì˜¤ë¥˜", "ì‹¤íŒ¨", "ì°¾ì§€ ëª»í–ˆ", "ê²°ê³¼ê°€ ì—†",
                                "ì•Œ ìˆ˜ ì—†", "ì§€ì›í•˜ì§€ ì•Š", "ê³¤ë€", "ì–´ë ¤ìš¸ ê²ƒ ê°™", "ì–´ë ¤ì›Œ",
                                "ë¶€ì¡±", "ë‹¤ì‹œ í•œë²ˆ ë§ì”€í•´ ì£¼ì‹œê² ì–´ìš”?", "ì•„ì§ ì œê°€ ê³µë¶€ ì¤‘ì´ì—ìš”"
                            ];

                            // ë‹µë³€ì— í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                            const isNegativeResponse = negativeKeywords.some(keyword => data.answer.includes(keyword));

                            // ë‹µë³€ ì‹œ ëª¨ì…˜ ì²˜ë¦¬
                            if (model && !isMotionPlaying) {
                                if (isNegativeResponse) {
                                    // ë¶€ì •ì  ë‹µë³€ì¼ ê²½ìš° Fail ëª¨ì…˜ ì‹¤í–‰ (ë§ˆìš°ìŠ¤ ì¶”ì  ì •ì§€ í¬í•¨)
                                    playFailMotion();
                                } else {
                                    // ì¼ë°˜ ë‹µë³€ì¼ ê²½ìš° ê¸°ì¡´ ë¡œì§ ìœ ì§€
                                    try { model.motion('Tap'); } catch(e){}
                                }
                            }
                        } else {
                            addMessage("ì£„ì†¡í•´ìš”, ì—°ê²°ì´ ì›í™œí•˜ì§€ ì•Šì•„ìš” ğŸ˜¥", 'bot-message');
                            // í†µì‹  ì˜¤ë¥˜ ì‹œì—ë„ Fail ëª¨ì…˜ ì‹¤í–‰
                            playFailMotion();
                        }

                    } catch (error) {
                        console.error('Chat Error:', error);
                        addMessage("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'bot-message');
                        // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ Fail ëª¨ì…˜ ì‹¤í–‰
                        playFailMotion();
                    }
                }

                sendBtn?.addEventListener('click', sendMessage);
                input?.addEventListener('keypress', e => {
                    if (e.key === 'Enter') sendMessage();
                });

                function addMessage(text, type) {
                    const div = document.createElement('div');
                    div.className = `message ${type}`;
                    div.textContent = text;
                    messages.appendChild(div);
                    messages.scrollTop = messages.scrollHeight;
                }

                // HelloMotion ì‹¤í–‰ í•¨ìˆ˜
                function playHelloMotion() {
                    if (!model) return;

                    // [í•µì‹¬] ì´ë¯¸ ëª¨ì…˜ì´ ì¬ìƒ ì¤‘ì´ë¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ (ì¤‘ë³µ ë°©ì§€)
                    if (isMotionPlaying) return;

                    try {
                        // ìƒíƒœ ì ê¸ˆ
                        isMotionPlaying = true;
                        isTrackingSuspended = true;

                        // ì‹œì„  ì •ë©´ ê³ ì •
                        if (model.internalModel && model.internalModel.focusController) {
                            model.internalModel.focusController.focus(0, 0);
                        }

                        // ëª¨ì…˜ ì‹¤í–‰
                        model.motion('Start', 0, 3);

                        // 3ì´ˆ í›„ ì ê¸ˆ í•´ì œ
                        setTimeout(() => {
                            isMotionPlaying = false;
                            isTrackingSuspended = false;
                        }, 3000);

                    } catch (e) {
                        console.warn(e);
                        // ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì ê¸ˆ í•´ì œ
                        isMotionPlaying = false;
                        isTrackingSuspended = false;
                    }
                }

                // [ì‹ ê·œ ì¶”ê°€] FailMotion ì‹¤í–‰ í•¨ìˆ˜ (HelloMotionê³¼ ë™ì¼í•œ ë°©ì‹ ì ìš©)
                function playFailMotion() {
                    if (!model) return;

                    // ì´ë¯¸ ëª¨ì…˜ì´ ì¬ìƒ ì¤‘ì´ë¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
                    if (isMotionPlaying) return;

                    try {
                        // ìƒíƒœ ì ê¸ˆ (ë§ˆìš°ìŠ¤ ì¶”ì  ë°©ì§€)
                        isMotionPlaying = true;
                        isTrackingSuspended = true;

                        // ì‹œì„  ì •ë©´ ê³ ì •
                        if (model.internalModel && model.internalModel.focusController) {
                            model.internalModel.focusController.focus(0, 0);
                        }

                        // Fail ëª¨ì…˜ ì‹¤í–‰ (model3.jsonì˜ Motions ê·¸ë£¹ëª… 'Fail')
                        model.motion('Fail', 0, 3);

                        // FailMotionì˜ Durationì´ ì•½ 2.967ì´ˆì´ë¯€ë¡œ 3ì´ˆ ëŒ€ê¸° í›„ ì ê¸ˆ í•´ì œ
                        setTimeout(() => {
                            isMotionPlaying = false;
                            isTrackingSuspended = false;
                        }, 3000);

                    } catch (e) {
                        console.warn("FailMotion play failed:", e);
                        // ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì ê¸ˆ í•´ì œ
                        isMotionPlaying = false;
                        isTrackingSuspended = false;
                    }
                }

                // ================= Live2D ë¡œì§ =================
                async function initLive2D() {
                    if (!window.PIXI || !window.Live2DCubismCore || !window.PIXI.live2d) return;

                    try {
                        const w = stage.clientWidth;
                        const h = stage.clientHeight;

                        app = new PIXI.Application({
                            view: live2dCanvas,
                            width: w,
                            height: h,
                            transparent: true,
                            antialias: true,
                            autoDensity: true,
                            resolution: window.devicePixelRatio || 1
                        });

                        const modelUrl = "/live2d/polia.model3.json";

                        model = await PIXI.live2d.Live2DModel.from(modelUrl);

                        app.stage.addChild(model);

                        fitModel();

                        model.interactive = true;
                        model.autoInteract = false;
                        model.buttonMode = true;

                        // [ìˆ˜ì •ë¨] í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                        model.on('pointertap', (e) => {
                            // [í•µì‹¬] ì´ë¯¸ ëª¨ì…˜ì´ ì¬ìƒ ì¤‘ì´ë©´ í´ë¦­ ë¬´ì‹œ! (íŒ” ë©ˆì¶¤ ë°©ì§€)
                            if (isMotionPlaying) {
                                console.log("ëª¨ì…˜ ì¬ìƒ ì¤‘ì´ë¼ í´ë¦­ ë¬´ì‹œë¨");
                                return;
                            }

                            const point = e.data.global;

                            if (model.hitTest('HeatArea', point.x, point.y)) {

                                // ìƒíƒœ ì ê¸ˆ
                                isMotionPlaying = true;
                                isTrackingSuspended = true;

                                // ì‹œì„  ì •ë©´ ê³ ì •
                                if (model.internalModel && model.internalModel.focusController) {
                                    model.internalModel.focusController.focus(0, 0);
                                }

                                try {
                                    // ëª¨ì…˜ ì‹¤í–‰
                                    model.motion('TapBody', 0, 3);
                                } catch(err) {
                                    console.warn("Motion play failed:", err);
                                }

                                // 3ì´ˆ í›„ ì ê¸ˆ í•´ì œ (ì• ë‹ˆë©”ì´ì…˜ ê¸¸ì´ë§Œí¼ ëŒ€ê¸°)
                                setTimeout(() => {
                                    isMotionPlaying = false;
                                    isTrackingSuspended = false;
                                }, 3000);
                            }
                        });

                        window.addEventListener('mousemove', (e) => {
                            if (!model) return;

                            // ëª¨ì…˜ ì¬ìƒ ì¤‘ì´ë©´ ì‹œì„  ì¶”ì  ì¤‘ì§€
                            if (isTrackingSuspended) return;

                            const rect = live2dCanvas.getBoundingClientRect();
                            const mouseX = e.clientX - rect.left;
                            const mouseY = e.clientY - rect.top;

                            const centerX = rect.width / 2;
                            const centerY = rect.height / 2;

                            const dist = Math.sqrt(
                                Math.pow(mouseX - centerX, 2) +
                                Math.pow(mouseY - centerY, 2)
                            );

                            const deadZoneRadius = 120;

                            if (dist < deadZoneRadius) {
                                if (model.internalModel && model.internalModel.focusController) {
                                    model.internalModel.focusController.focus(0, 0);
                                }
                            } else {
                                model.focus(mouseX, mouseY);
                            }
                        });

                        window.addEventListener('resize', resizeLive2D);

                    } catch (err) {
                        console.error("Live2D Load Error:", err);
                        if(loadingDiv) loadingDiv.textContent = "ìºë¦­í„° ë¡œë”© ì‹¤íŒ¨";
                    }
                }

                function resizeLive2D() {
                    if (!app || !model) return;
                    const w = stage.clientWidth;
                    const h = stage.clientHeight;
                    app.renderer.resize(w, h);
                    fitModel();
                }

                function fitModel() {
                    if (!model || !stage) return;
                    const w = stage.clientWidth;
                    const h = stage.clientHeight;

                    model.scale.set(1, 1);

                    if (model.anchor) {
                        model.anchor.set(0.5, 1.0);
                    }

                    model.x = w * 0.5;
                    model.y = h;

                    const scaleHeight = (h * 0.95) / model.height;
                    const scaleWidth = (w * 0.9) / model.width;
                    const scale = Math.min(scaleHeight, scaleWidth);

                    model.scale.set(scale);
                }
            });
        </script>

    </th:block>
</div>