<div th:fragment="chatbot" xmlns:th="http://www.w3.org/1999/xhtml">

    <th:block th:if="${session.loginMember != null}">

        <link rel="stylesheet" th:href="@{/css/chatbot.css}">

        <script th:src="@{/live2d/live2dcubismcore.min.js}"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.10/browser/pixi.min.js"></script>
        <script>window.PIXI = PIXI;</script>
        <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/cubism4.min.js"></script>

        <div id="chatbot-container">
            <button id="chatbot-toggle-btn" aria-label="ì±—ë´‡ ì—´ê¸°">
                <img class="chatbot-icon-img" th:src="@{/image/chatbot_icon.png}" alt="PoliSight ì±—ë´‡ ì•„ì´ì½˜">
            </button>

            <div id="chatbot-window">

                <div id="live2d-stage">
                    <canvas id="live2d-canvas"></canvas>
                </div>

                <div id="chatbot-right-panel">
                    <div class="chatbot-header">
                        <span>PoliSight AI</span>
                        <button id="chatbot-close-btn">&times;</button>
                    </div>

                    <div id="chatbot-messages">
                        <div class="message bot-message">
                            ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š<br>
                            ì •ì±… ì‹œë®¬ë ˆì´ì…˜ì— ëŒ€í•´<br>
                            ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë´ ì£¼ì„¸ìš”.
                        </div>
                    </div>

                    <div class="chatbot-input-area">
                        <input type="text" id="chatbot-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">
                        <button id="chatbot-send-btn">ì „ì†¡</button>
                    </div>
                </div>

            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const toggleBtn = document.getElementById('chatbot-toggle-btn');
                const closeBtn = document.getElementById('chatbot-close-btn');
                const chatWindow = document.getElementById('chatbot-window');
                const sendBtn = document.getElementById('chatbot-send-btn');
                const input = document.getElementById('chatbot-input');
                const messages = document.getElementById('chatbot-messages');

                const live2dCanvas = document.getElementById('live2d-canvas');
                const stage = document.getElementById('live2d-stage');

                let app = null;
                let model = null;
                let initialized = false;

                if (!toggleBtn || !chatWindow) return;

                // ================= UI ì´ë²¤íŠ¸ =================
                toggleBtn.addEventListener('click', async () => {
                    chatWindow.classList.toggle('visible');

                    if (chatWindow.classList.contains('visible')) {
                        setTimeout(() => input?.focus(), 100);

                        if (!initialized) {
                            initialized = true;
                            await initLive2D();
                        } else {
                            setTimeout(() => resizeLive2D(), 50);
                        }
                    }
                });

                closeBtn?.addEventListener('click', () => {
                    chatWindow.classList.remove('visible');
                });

                function sendMessage() {
                    const text = input.value.trim();
                    if (!text) return;
                    addMessage(text, 'user-message');
                    input.value = '';

                    setTimeout(() => {
                        addMessage("ì•Œê² ìŠµë‹ˆë‹¤! ğŸ‘\ní•´ë‹¹ ì •ì±… ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤.", 'bot-message');
                        if (model) {
                            try { model.motion('Tap'); } catch(e){}
                        }
                    }, 600);
                }

                sendBtn?.addEventListener('click', sendMessage);
                input?.addEventListener('keypress', e => {
                    if (e.key === 'Enter') sendMessage();
                });

                function addMessage(text, type) {
                    const div = document.createElement('div');
                    div.className = `message ${type}`;
                    div.textContent = text;
                    messages.appendChild(div);
                    messages.scrollTop = messages.scrollHeight;
                }

                // ================= Live2D ë¡œì§ =================
                async function initLive2D() {
                    if (!window.PIXI || !window.Live2DCubismCore || !window.PIXI.live2d) return;

                    try {
                        const w = stage.clientWidth;
                        const h = stage.clientHeight;

                        app = new PIXI.Application({
                            view: live2dCanvas,
                            width: w,
                            height: h,
                            transparent: true,
                            antialias: true,
                            autoDensity: true,
                            resolution: window.devicePixelRatio || 1
                        });

                        const modelUrl = "/live2d/polia.model3.json";
                        model = await PIXI.live2d.Live2DModel.from(modelUrl);
                        app.stage.addChild(model);

                        fitModel();

                        model.interactive = true;
                        model.buttonMode = true;
                        model.on('pointertap', () => {
                            try { model.motion('Tap'); } catch(e) {}
                        });

                        // -----------------------------------------------------------
                        // [ìˆ˜ì •ë¨] ë°ë“œì¡´ ë° ì •ë©´ ì‘ì‹œ ë¡œì§ ê°œì„ 
                        // -----------------------------------------------------------
                        stage.addEventListener('mousemove', (e) => {
                            if (!model) return;

                            const rect = live2dCanvas.getBoundingClientRect();
                            const mouseX = e.clientX - rect.left;
                            const mouseY = e.clientY - rect.top;

                            // ë°ë“œì¡´ì˜ ì¤‘ì‹¬ì  (í™”ë©´ ì¤‘ì•™)
                            const centerX = rect.width / 2;
                            const centerY = rect.height / 2;

                            // ê±°ë¦¬ ê³„ì‚°
                            const dist = Math.sqrt(
                                Math.pow(mouseX - centerX, 2) +
                                Math.pow(mouseY - centerY, 2)
                            );

                            // ë°ë“œì¡´ ë°˜ê²½
                            const deadZoneRadius = 120;

                            if (dist < deadZoneRadius) {
                                // [ì¤‘ìš”] ë°ë“œì¡´ ë‚´ë¶€: ë‚´ë¶€ ì»¨íŠ¸ë¡¤ëŸ¬ì— (0,0)ì„ ë³´ë‚´ì•¼ ì§„ì§œ ì •ë©´ì„ ë´…ë‹ˆë‹¤.
                                // model.focus(centerX, centerY)ëŠ” í™”ë©´ ì¤‘ì•™(ë°°ê¼½)ì„ ë³´ê²Œ ë§Œë“­ë‹ˆë‹¤.
                                if (model.internalModel && model.internalModel.focusController) {
                                    model.internalModel.focusController.focus(0, 0);
                                }
                            } else {
                                // ë°ë“œì¡´ ì™¸ë¶€: ë§ˆìš°ìŠ¤ ì¢Œí‘œ ì‘ì‹œ
                                model.focus(mouseX, mouseY);
                            }
                        });
                        // -----------------------------------------------------------

                        window.addEventListener('resize', resizeLive2D);

                    } catch (err) {
                        console.error("Live2D Load Error:", err);
                    }
                }

                function resizeLive2D() {
                    if (!app || !model) return;
                    const w = stage.clientWidth;
                    const h = stage.clientHeight;
                    app.renderer.resize(w, h);
                    fitModel();
                }

                function fitModel() {
                    if (!model || !stage) return;
                    const w = stage.clientWidth;
                    const h = stage.clientHeight;

                    model.scale.set(1, 1);

                    if (model.anchor) {
                        model.anchor.set(0.5, 1.0);
                    }

                    model.x = w * 0.5;
                    model.y = h;

                    const scaleHeight = (h * 0.95) / model.height;
                    const scaleWidth = (w * 0.9) / model.width;
                    const scale = Math.min(scaleHeight, scaleWidth);

                    model.scale.set(scale);
                }
            });
        </script>

    </th:block>
</div>