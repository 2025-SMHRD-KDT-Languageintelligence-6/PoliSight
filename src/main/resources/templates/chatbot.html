<div th:fragment="chatbot" xmlns:th="http://www.w3.org/1999/xhtml">

    <th:block th:if="${session.loginMember != null}">

        <link rel="stylesheet" th:href="@{/css/chatbot.css}">

        <script th:src="@{/live2d/live2dcubismcore.min.js}"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.10/browser/pixi.min.js"></script>
        <script>window.PIXI = PIXI;</script>
        <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/cubism4.min.js"></script>

        <div id="chatbot-container">
            <button id="chatbot-toggle-btn" aria-label="ì±—ë´‡ ì—´ê¸°">
                <img class="chatbot-icon-img" th:src="@{/image/chatbot_icon.png}" alt="PoliSight ì±—ë´‡ ì•„ì´ì½˜">
            </button>

            <div id="chatbot-window">

                <div id="live2d-stage">
                    <canvas id="live2d-canvas"></canvas>
                </div>

                <div id="chatbot-right-panel">
                    <div class="chatbot-header">
                        <span>PoliSight AI</span>
                        <button id="chatbot-close-btn">&times;</button>
                    </div>

                    <div id="chatbot-messages">
                        <div class="message bot-message">
                            ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š<br>
                            ì •ì±… ì‹œë®¬ë ˆì´ì…˜ì— ëŒ€í•´<br>
                            ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë´ ì£¼ì„¸ìš”.
                        </div>
                    </div>

                    <div class="chatbot-input-area">
                        <input type="text" id="chatbot-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">
                        <button id="chatbot-send-btn">ì „ì†¡</button>
                    </div>
                </div>

            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const toggleBtn = document.getElementById('chatbot-toggle-btn');
                const closeBtn = document.getElementById('chatbot-close-btn');
                const chatWindow = document.getElementById('chatbot-window');
                const sendBtn = document.getElementById('chatbot-send-btn');
                const input = document.getElementById('chatbot-input');
                const messages = document.getElementById('chatbot-messages');

                const live2dCanvas = document.getElementById('live2d-canvas');
                const stage = document.getElementById('live2d-stage');

                let app = null;
                let model = null;
                let initialized = false;

                if (!toggleBtn || !chatWindow) return;

                // ================= UI ì´ë²¤íŠ¸ =================
                toggleBtn.addEventListener('click', async () => {
                    chatWindow.classList.toggle('visible');

                    if (chatWindow.classList.contains('visible')) {
                        setTimeout(() => input?.focus(), 100);

                        if (!initialized) {
                            initialized = true;
                            await initLive2D();
                        } else {
                            // ì°½ì´ ì—´ë¦´ ë•Œë§ˆë‹¤ ë¦¬ì‚¬ì´ì¦ˆ ì¬ê³„ì‚° (ì•ˆì „ì¥ì¹˜)
                            setTimeout(() => resizeLive2D(), 50);
                        }
                    }
                });

                closeBtn?.addEventListener('click', () => {
                    chatWindow.classList.remove('visible');
                });

                function sendMessage() {
                    const text = input.value.trim();
                    if (!text) return;
                    addMessage(text, 'user-message');
                    input.value = '';

                    setTimeout(() => {
                        addMessage("ì•Œê² ìŠµë‹ˆë‹¤! ğŸ‘\ní•´ë‹¹ ì •ì±… ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤.", 'bot-message');
                        if (model) {
                            try { model.motion('Tap'); } catch(e){}
                        }
                    }, 600);
                }

                sendBtn?.addEventListener('click', sendMessage);
                input?.addEventListener('keypress', e => {
                    if (e.key === 'Enter') sendMessage();
                });

                function addMessage(text, type) {
                    const div = document.createElement('div');
                    div.className = `message ${type}`;
                    div.textContent = text;
                    messages.appendChild(div);
                    messages.scrollTop = messages.scrollHeight;
                }

                // ================= Live2D ë¡œì§ =================
                async function initLive2D() {
                    if (!window.PIXI || !window.Live2DCubismCore || !window.PIXI.live2d) return;

                    try {
                        const w = stage.clientWidth;
                        const h = stage.clientHeight;

                        app = new PIXI.Application({
                            view: live2dCanvas,
                            width: w,
                            height: h,
                            transparent: true,
                            antialias: true,
                            autoDensity: true,
                            resolution: window.devicePixelRatio || 1
                        });

                        const modelUrl = "/live2d/polia.model3.json";
                        model = await PIXI.live2d.Live2DModel.from(modelUrl);
                        app.stage.addChild(model);

                        fitModel();

                        model.interactive = true;
                        model.buttonMode = true;
                        model.on('pointertap', () => {
                            try { model.motion('Tap'); } catch(e) {}
                        });

                        window.addEventListener('resize', resizeLive2D);

                    } catch (err) {
                        console.error("Live2D Load Error:", err);
                    }
                }

                function resizeLive2D() {
                    if (!app || !model) return;
                    const w = stage.clientWidth;
                    const h = stage.clientHeight;
                    app.renderer.resize(w, h);
                    fitModel();
                }

                // ================= [í•µì‹¬] ì „ì‹  ë§ì¶¤ ë¡œì§ =================
                function fitModel() {
                    if (!model || !stage) return;
                    const w = stage.clientWidth;
                    const h = stage.clientHeight;

                    // 1. ê³„ì‚° ì „ì— ìŠ¤ì¼€ì¼ì„ 1ë¡œ ì´ˆê¸°í™”í•˜ì—¬ 'ì›ë³¸ í¬ê¸°'ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•˜ë„ë¡ í•¨
                    model.scale.set(1, 1);

                    // 2. ê¸°ì¤€ì : ì¤‘ì•™ í•˜ë‹¨ (ë°œ ë)
                    if (model.anchor) {
                        model.anchor.set(0.5, 1.0);
                    }

                    // 3. ìœ„ì¹˜: ê°€ë¡œ ì¤‘ì•™, ì„¸ë¡œ ë§¨ ì•„ë˜
                    model.x = w * 0.5;
                    model.y = h;

                    // 4. í¬ê¸°: ì „ì‹ ì´ ë‹¤ ë³´ì´ê²Œ (ë†’ì´ ê¸°ì¤€ 95%)
                    // í™”ë©´ ë†’ì´ì˜ 95% í¬ê¸°ë¡œ ë§ì¶¥ë‹ˆë‹¤. (ì•½ê°„ì˜ ì—¬ë°± í¬í•¨)
                    const scaleHeight = (h * 0.95) / model.height;

                    // í˜¹ì‹œ ê°€ë¡œí­ì´ ì¢ì•„ì„œ ì˜ë¦¬ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ê°€ë¡œ/ì„¸ë¡œ ì¤‘ ì‘ì€ ë¹„ìœ¨ ì„ íƒ
                    const scaleWidth = (w * 0.9) / model.width;

                    const scale = Math.min(scaleHeight, scaleWidth);

                    model.scale.set(scale);
                }
            });
        </script>

    </th:block>
</div>