<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoliSight - 시뮬레이션 설정</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: {
                            900: '#070F22',
                            800: '#162133',
                            700: '#2B394D',
                            600: '#3F4D61',
                            500: '#57677E',
                            400: '#8796AB',
                        }
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { width: 4px; }
        .scrollbar-hide::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-hide::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }

        .selection-card:checked ~ div {
            border-color: #2563EB; background-color: #EFF6FF; color: #1e40af;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1);
        }
        .selection-card:checked ~ div .check-icon { opacity: 1; transform: scale(1); }
        .gender-radio:checked + span { background-color: #2563EB; color: white; border-color: #2563EB; }

        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #2563EB; cursor: pointer; margin-top: -6px; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #E2E8F0; border-radius: 2px;
        }
        input[type=range]:focus::-webkit-slider-runnable-track { background: #CBD5E1; }

        select.custom-select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 14px;
            padding-right: 30px;
            appearance: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col min-h-screen text-sm">

<nav th:replace="~{HF :: nav}" class="sticky top-0 z-40 bg-white/90 border-b border-slate-200 backdrop-blur-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-14 items-center"><span>PoliSight</span></div>
    </div>
</nav>

<main class="flex-grow max-w-7xl mx-auto px-4 py-10 w-full grid lg:grid-cols-12 gap-8">

    <aside class="lg:col-span-4 h-fit lg:sticky lg:top-20">
        <div class="bg-white rounded-2xl border border-blue-100 shadow-lg shadow-blue-50/50 p-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4 z-0"></div>
            <div class="relative z-10">
                <div class="flex items-center gap-2 text-sm text-blue-600 font-bold mb-4">
                    <i class="fa-solid fa-crosshairs"></i> 분석 대상 정책
                </div>

                <div class="mb-5">
                    <span class="inline-block text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded mb-1"
                          th:text="${policy != null ? policy.region : '전국'}">지역</span>
                    <h2 id="display-policy-title" class="font-bold text-xl text-slate-900 leading-tight"
                        th:text="${policy != null ? policy.title : '정책 선택 필요'}">정책명</h2>
                </div>

                <div class="space-y-4 text-sm text-slate-600 border-t border-slate-100 pt-4">

                    <div class="flex flex-col gap-1.5">
                        <span class="text-slate-400 text-xs font-bold">지원 내용</span>
                        <div class="relative">
                            <p id="policyDescription" class="font-medium text-slate-700 leading-relaxed line-clamp-3 break-keep"
                               th:text="${policy != null ? policy.description : '-'}">
                                -
                            </p>
                            <button id="moreBtn" type="button" onclick="toggleDescription()" class="hidden w-full justify-end text-xs text-blue-600 font-bold mt-1 hover:underline focus:outline-none flex items-center gap-1">
                                더보기 <i class="fa-solid fa-chevron-down text-[10px]"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex justify-between items-center pt-2 border-t border-slate-50">
                        <span class="text-slate-400 text-xs">분야</span>
                        <span class="font-bold text-slate-700"
                              th:text="${policy != null ? policy.department : '-'}">분야</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-slate-400 text-xs">마감일</span>
                        <span class="font-bold text-orange-500"
                              th:text="${policy != null ? policy.bizPrdEndYmd : '-'}">2025.12.31</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-6 bg-slate-100 rounded-xl p-5 border border-slate-200">
            <div class="flex gap-3">
                <i class="fa-solid fa-lightbulb text-yellow-500 mt-1"></i>
                <div>
                    <h4 class="font-bold text-sm text-slate-800 mb-1">정확한 정보를 입력해주세요</h4>
                    <p class="text-xs text-slate-500 leading-relaxed">입력하신 정보는 오직 시뮬레이션 목적으로만 사용되며, 저장되지 않습니다.</p>
                </div>
            </div>
        </div>
    </aside>

    <section class="lg:col-span-8">
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
            <div class="mb-6 border-b border-slate-100 pb-4">
                <h1 class="text-xl font-bold text-slate-900 mb-2">상세 조건 설정</h1>
                <p class="text-slate-500 text-sm">조건을 수정하거나 프롬프트로 상황을 입력해 달라지는 결과를 시뮬레이션 해 보세요.</p>
            </div>

            <form id="simulationForm" th:action="@{/simulation/analyze}" th:object="${simulationForm}" method="post" class="space-y-8">

                <input type="hidden" name="policyId" th:value="${policy != null ? policy.id : ''}" />
                <input type="hidden" name="keyword" th:value="${policy != null ? policy.title : ''}" />

                <div>
                    <h3 class="font-bold text-base text-slate-800 mb-3 flex items-center gap-2">
                        <span class="w-5 h-5 bg-slate-800 text-white rounded-full flex items-center justify-center text-[10px]">1</span>
                        기본 인적 사항
                    </h3>
                    <div class="grid md:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1.5">성별</label>
                            <div class="flex gap-2">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" th:field="*{gender}" value="male" class="gender-radio sr-only">
                                    <span class="block w-full text-center py-2.5 rounded-xl border border-slate-300 font-medium text-slate-600 transition hover:bg-slate-50 text-sm">남성</span>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" th:field="*{gender}" value="female" class="gender-radio sr-only">
                                    <span class="block w-full text-center py-2.5 rounded-xl border border-slate-300 font-medium text-slate-600 transition hover:bg-slate-50 text-sm">여성</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1.5">생년월일</label>
                            <div class="relative">
                                <input type="text" th:field="*{birthDate}" id="birthDate" class="w-full p-2.5 rounded-xl border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-blue-500 focus:outline-none font-bold text-slate-800 text-sm pr-10" placeholder="YYYYMMDD (예: 19950101)" maxlength="8">
                                <input type="date" id="hiddenDatePicker" class="absolute inset-0 opacity-0 cursor-pointer -z-10" tabindex="-1">
                                <i class="fa-regular fa-calendar absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 cursor-pointer text-lg"
                                   onclick="document.getElementById('hiddenDatePicker').showPicker()"></i>
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-600 mb-1.5">현재 거주지역 (주민등록지 기준)</label>
                            <div class="grid grid-cols-2 gap-3">
                                <select th:field="*{regionSi}" id="regionSi" class="w-full p-2.5 rounded-xl border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-blue-500 focus:outline-none font-medium text-slate-700 text-sm custom-select" onchange="updateRegionGu()">
                                    <option value="">시/도 선택</option>
                                </select>
                                <select th:field="*{regionGu}" id="regionGu" class="w-full p-2.5 rounded-xl border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-blue-500 focus:outline-none font-medium text-slate-700 text-sm custom-select">
                                    <option value="">시/군/구 선택</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="font-bold text-base text-slate-800 mb-3 flex items-center gap-2">
                        <span class="w-5 h-5 bg-slate-800 text-white rounded-full flex items-center justify-center text-[10px]">2</span>
                        사회적 상태
                    </h3>
                    <div class="grid md:grid-cols-2 gap-5 mb-5">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1.5">최종 학력</label>
                            <select th:field="*{educationLevel}" class="w-full p-2.5 rounded-xl border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-blue-500 focus:outline-none font-medium text-slate-700 text-sm custom-select">
                                <option value="">선택해주세요</option>
                                <option value="0049001">고졸 미만 (중졸 이하)</option>
                                <option value="0049002">고교 재학</option>
                                <option value="0049003">고졸 예정 (3학년)</option>
                                <option value="0049004">고교 졸업 (검정고시 포함)</option>
                                <option value="0049005">대학 재학 (휴학 포함)</option>
                                <option value="0049006">대졸 예정 (졸업 유예)</option>
                                <option value="0049007">대학 졸업</option>
                                <option value="0049008">석/박사 (과정/졸업)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1.5">고용 상태</label>
                            <select th:field="*{employmentStatus}" class="w-full p-2.5 rounded-xl border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-blue-500 focus:outline-none font-medium text-slate-700 text-sm custom-select">
                                <option value="">선택해주세요</option>
                                <option value="UNEMPLOYED">미취업 (구직자)</option>
                                <option value="EMPLOYED">직장인 (정규/계약/아르바이트)</option>
                                <option value="SELF_EMPLOYED">자영업 / 소상공인</option>
                                <option value="FREELANCER">프리랜서</option>
                                <option value="FOUNDER">(예비) 창업자</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="font-bold text-base text-slate-800 mb-3 flex items-center gap-2">
                        <span class="w-5 h-5 bg-slate-800 text-white rounded-full flex items-center justify-center text-[10px]">3</span>
                        가구 및 경제 상황
                    </h3>

                    <div class="mb-5">
                        <label class="block text-xs font-bold text-slate-600 mb-1.5">결혼 여부</label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="cursor-pointer relative group">
                                <input type="radio" th:field="*{marry}" value="N" class="selection-card sr-only">
                                <div class="p-3 rounded-xl border border-slate-200 hover:bg-slate-50 transition flex flex-col items-center justify-center text-center h-full group-hover:border-slate-300">
                                    <i class="fa-solid fa-check-circle absolute top-2 right-2 text-blue-600 opacity-0 check-icon transition-transform scale-50 text-sm"></i>
                                    <span class="font-bold text-slate-700 text-sm">미혼</span>
                                </div>
                            </label>
                            <label class="cursor-pointer relative group">
                                <input type="radio" th:field="*{marry}" value="Y" class="selection-card sr-only">
                                <div class="p-3 rounded-xl border border-slate-200 hover:bg-slate-50 transition flex flex-col items-center justify-center text-center h-full group-hover:border-slate-300">
                                    <i class="fa-solid fa-check-circle absolute top-2 right-2 text-blue-600 opacity-0 check-icon transition-transform scale-50 text-sm"></i>
                                    <span class="font-bold text-slate-700 text-sm">기혼</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-5 mb-5">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1.5">자녀 수</label>
                            <div class="relative">
                                <input type="number" th:field="*{childCount}" min="0" class="w-full p-2.5 pl-4 pr-12 rounded-xl border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-blue-500 focus:outline-none font-bold text-slate-800 text-sm">
                                <span class="absolute right-4 top-2.5 text-slate-400 text-xs font-bold">명</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1.5">가구원 수 (본인 포함)</label>
                            <div class="relative">
                                <input type="number" th:field="*{familySize}" min="1" class="w-full p-2.5 pl-4 pr-12 rounded-xl border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-blue-500 focus:outline-none font-bold text-slate-800 text-sm">
                                <span class="absolute right-4 top-2.5 text-slate-400 text-xs font-bold">명</span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-5">
                        <label class="block text-xs font-bold text-slate-600 mb-1.5">주택 소유 여부</label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="cursor-pointer relative group">
                                <input type="radio" th:field="*{house}" value="N" class="selection-card sr-only">
                                <div class="p-3 rounded-xl border border-slate-200 hover:bg-slate-50 transition flex flex-col items-center justify-center text-center h-full group-hover:border-slate-300">
                                    <i class="fa-solid fa-check-circle absolute top-2 right-2 text-blue-600 opacity-0 check-icon transition-transform scale-50 text-sm"></i>
                                    <span class="font-bold text-slate-700 text-sm">미소유 (전/월세)</span>
                                </div>
                            </label>
                            <label class="cursor-pointer relative group">
                                <input type="radio" th:field="*{house}" value="Y" class="selection-card sr-only">
                                <div class="p-3 rounded-xl border border-slate-200 hover:bg-slate-50 transition flex flex-col items-center justify-center text-center h-full group-hover:border-slate-300">
                                    <i class="fa-solid fa-check-circle absolute top-2 right-2 text-blue-600 opacity-0 check-icon transition-transform scale-50 text-sm"></i>
                                    <span class="font-bold text-slate-700 text-sm">소유 (자가)</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1.5">본인 월 소득 (세전)</label>
                            <div class="bg-slate-50 border border-slate-300 rounded-xl p-3 focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 transition">
                                <div class="flex items-center justify-between mb-2 gap-2">
                                    <input type="text" id="my_income_text" th:field="*{income}" class="w-full bg-transparent font-bold text-slate-800 text-sm focus:outline-none text-right" placeholder="0">
                                    <span class="text-xs font-bold text-slate-500 whitespace-nowrap">만원</span>
                                </div>
                                <input type="range" id="my_income_range" min="0" max="1500" step="10" value="0" class="block w-full">
                            </div>
                            <p class="text-[11px] text-blue-500 mt-1.5 font-medium flex items-center gap-1">
                                <i class="fa-solid fa-check"></i> 0원 입력 시 '소득 없음' 처리
                            </p>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1.5">가구 합산 월 소득 (세전)</label>
                            <div class="bg-slate-50 border border-slate-300 rounded-xl p-3 focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 transition">
                                <div class="flex items-center justify-between mb-2 gap-2">
                                    <input type="text" id="household_income_text" th:field="*{householdIncome}" class="w-full bg-transparent font-bold text-slate-800 text-sm focus:outline-none text-right" placeholder="0">
                                    <span class="text-xs font-bold text-slate-500 whitespace-nowrap">만원</span>
                                </div>
                                <input type="range" id="household_income_range" min="0" max="2000" step="10" value="0" class="block w-full">
                            </div>
                            <p class="text-[11px] text-blue-500 mt-1.5 font-medium flex items-center gap-1">
                                <i class="fa-solid fa-check"></i> * 부모님, 배우자 소득 포함
                            </p>
                        </div>
                    </div>
                </div>

                <div class="mt-8 pt-8 border-t border-slate-100">
                    <h3 class="font-bold text-base text-slate-800 mb-3 flex items-center gap-2">
                        <span class="w-5 h-5 bg-indigo-600 text-white rounded-full flex items-center justify-center text-[10px]">
                            <i class="fa-solid fa-robot"></i>
                        </span>
                        AI 정밀 분석 요청 (선택)
                    </h3>
                    <div class="bg-indigo-50/60 rounded-xl p-5 border border-indigo-100">
                        <div class="flex justify-between items-end mb-2 flex-wrap gap-2">
                            <label for="ai_prompt" class="block text-sm font-bold text-indigo-900 break-keep leading-snug">
                                위 선택지에는 없는 특수한 상황이 있다면 적어주세요.
                            </label>
                            <span id="charCount" class="text-xs text-indigo-500 font-bold shrink-0">0/500자</span>
                        </div>

                        <textarea id="ai_prompt" th:field="*{userPrompt}" rows="3" maxlength="500" oninput="updateCharCount(this)" class="w-full p-3 rounded-xl border border-indigo-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none text-sm resize-none placeholder-slate-400" placeholder="예: 프리랜서라 소득이 불규칙해요, 부모님과 주민등록은 같이 되어있는데 실거주는 따로 해요 등"></textarea>

                        <p class="text-[11px] text-indigo-500 mt-2 flex items-center gap-1">
                            <i class="fa-solid fa-circle-info"></i>
                            작성해주신 내용은 AI가 분석하여 시뮬레이션 결과에 반영합니다.
                        </p>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white py-3.5 rounded-xl font-bold text-lg shadow-xl shadow-blue-200 transition transform hover:-translate-y-1 flex justify-center items-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> 분석 결과 보기
                    </button>
                    <p class="text-center text-[10px] text-slate-400 mt-3">
                        * PoliSight는 사용자의 민감한 개인정보를 서버에 저장하지 않습니다.
                    </p>
                </div>

            </form>
        </div>
    </section>
</main>

<footer th:replace="~{HF :: footer}" class="bg-slate-900 text-slate-300 py-10 mt-auto relative z-10 border-t border-slate-800">
    <div class="max-w-7xl mx-auto px-4">
        <div class="whitespace-nowrap flex items-end text-slate-600 justify-center">
            &copy; 2026 TEAM SimPol. All rights reserved.
        </div>
    </div>
</footer>

<div id="loadingModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm hidden">
    <div class="bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center justify-center max-w-sm w-full mx-4 border border-slate-100 transform transition-all animate-fade-in">
        <div class="relative mb-6">
            <div class="w-16 h-16 border-4 border-blue-100 rounded-full"></div>
            <div class="w-16 h-16 border-4 border-blue-600 rounded-full animate-spin absolute top-0 border-t-transparent"></div>
            <div class="absolute inset-0 flex items-center justify-center text-blue-600">
                <i class="fa-solid fa-robot text-lg animate-pulse"></i>
            </div>
        </div>

        <h3 class="text-xl font-bold text-slate-800 mb-2">AI 정밀 분석 중...</h3>
        <p class="text-slate-500 text-sm text-center leading-relaxed">
            입력하신 조건과 최신 정책 데이터를<br>
            대조하고 있습니다.<br>
        </p>
    </div>
</div>

<div th:replace="~{chatbot :: chatbot}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/

        const areaData = {
            "서울특별시": ["종로구","중구","용산구","성동구","광진구","동대문구","중랑구","성북구","강북구","도봉구","노원구","은평구","서대문구","마포구","양천구","강서구","구로구","금천구","영등포구","동작구","관악구","서초구","강남구","송파구","강동구"],
            "부산광역시": ["중구","서구","동구","영도구","부산진구","동래구","남구","북구","해운대구","사하구","금정구","강서구","연제구","수영구","사상구","기장군"],
            "대구광역시": ["중구","동구","서구","남구","북구","수성구","달서구","달성군","군위군"],
            "인천광역시": ["중구","동구","미추홀구","연수구","남동구","부평구","계양구","서구","강화군","옹진군"],
            "광주광역시": ["동구","서구","남구","북구","광산구"],
            "대전광역시": ["동구","중구","서구","유성구","대덕구"],
            "울산광역시": ["중구","남구","동구","북구","울주군"],
            "세종특별자치시": ["세종특별자치시"],
            "경기도": [
                "수원시","수원시 장안구","수원시 권선구","수원시 팔달구","수원시 영통구",
                "성남시","성남시 수정구","성남시 중원구","성남시 분당구",
                "의정부시",
                "안양시","안양시 만안구","안양시 동안구",
                "부천시","부천시 원미구","부천시 소사구","부천시 오정구",
                "광명시","평택시","동두천시",
                "안산시","안산시 상록구","안산시 단원구",
                "고양시","고양시 덕양구","고양시 일산동구","고양시 일산서구",
                "과천시","구리시","남양주시","오산시","시흥시","군포시","의왕시","하남시",
                "용인시","용인시 처인구","용인시 기흥구","용인시 수지구",
                "파주시","이천시","안성시","김포시","화성시","광주시","양주시","포천시","여주시",
                "연천군","가평군","양평군"
            ],
            "강원특별자치도": ["춘천시","원주시","강릉시","동해시","태백시","속초시","삼척시","홍천군","횡성군","영월군","평창군","정선군","철원군","화천군","양구군","인제군","고성군","양양군"],
            "충청북도": ["청주시","청주시 상당구","청주시 서원구","청주시 흥덕구","청주시 청원구","충주시","제천시","보은군","옥천군","영동군","증평군","진천군","괴산군","음성군","단양군"],
            "충청남도": ["천안시","천안시 동남구","천안시 서북구","공주시","보령시","아산시","서산시","논산시","계룡시","당진시","금산군","부여군","서천군","청양군","홍성군","예산군","태안군"],
            "전북특별자치도": ["전주시","전주시 완산구","전주시 덕진구","군산시","익산시","정읍시","남원시","김제시","완주군","진안군","무주군","장수군","임실군","순창군","고창군","부안군"],
            "전라남도": ["목포시","여수시","순천시","나주시","광양시","담양군","곡성군","구례군","고흥군","보성군","화순군","장흥군","장흥군 장흥읍","강진군","해남군","영암군","무안군","함평군","영광군","장성군","완도군","진도군","신안군"],
            "경상북도": ["포항시","포항시 남구","포항시 북구","경주시","김천시","안동시","구미시","영주시","영천시","상주시","문경시","경산시","의성군","청송군","영양군","영덕군","청도군","고령군","성주군","칠곡군","예천군","봉화군","울진군","울릉군"],
            "경상남도": ["창원시","창원시 의창구","창원시 성산구","창원시 마산합포구","창원시 마산회원구","창원시 진해구","진주시","통영시","사천시","김해시","밀양시","거제시","양산시","의령군","함안군","창녕군","고성군","남해군","하동군","산청군","함양군","거창군","합천군"],
            "제주특별자치도": ["제주시","서귀포시"]
        };

        function updateRegionGu() {
            const siSelect = document.getElementById("regionSi");
            const guSelect = document.getElementById("regionGu");
            const selectedSi = siSelect.value;

            guSelect.innerHTML = '<option value="">시/군/구 선택</option>';

            if (selectedSi && areaData[selectedSi]) {
                const guList = areaData[selectedSi];
                guList.forEach(function(gu) {
                    const option = document.createElement("option");
                    option.value = gu;
                    option.text = gu;
                    guSelect.appendChild(option);
                });
            }
        }

        document.getElementById('hiddenDatePicker').addEventListener('change', function() {
            if(this.value) {
                const dateStr = this.value.replace(/-/g, '');
                document.getElementById('birthDate').value = dateStr;
            }
        });

        function setupIncomeInput(rangeId, textId) {
            const range = document.getElementById(rangeId);
            const text = document.getElementById(textId);
            if (!range || !text) return;

            const formatNumber = (num) => Number(num).toLocaleString();
            const parseNumber = (str) => Number(String(str).replace(/,/g, ''));

            let currentVal = text.value ? parseNumber(text.value) : 0;
            if (isNaN(currentVal) || currentVal === 0) {
                range.value = 0;
                text.value = 0;
            } else {
                range.value = currentVal;
                text.value = formatNumber(currentVal);
            }

            range.addEventListener('input', (e) => {
                text.value = formatNumber(e.target.value);
            });

            text.addEventListener('input', (e) => {
                let val = parseNumber(e.target.value);
                if (isNaN(val)) val = 0;
                let max = parseInt(range.max);
                if (val > max) val = max;
                range.value = val;
            });

            text.addEventListener('blur', (e) => {
                let val = parseNumber(e.target.value);
                if (isNaN(val)) val = 0;
                text.value = formatNumber(val);
                range.value = val;
            });
        }

        function loadPrevConditions() {
            const storedData = sessionStorage.getItem('simData');
            if (!storedData) return;

            const data = JSON.parse(storedData);
            const has = (v) => v !== undefined && v !== null && v !== "";

            if (has(data.birthDate)) document.getElementById('birthDate').value = data.birthDate;
            if (has(data.childCount)) document.querySelector('input[name="childCount"]').value = data.childCount;
            if (has(data.familySize)) document.querySelector('input[name="familySize"]').value = data.familySize;

            if (has(data.gender)) {
                const radio = document.querySelector(`input[name="gender"][value="${data.gender}"]`);
                if (radio) radio.checked = true;
            }
            if (has(data.marry)) {
                const radio = document.querySelector(`input[name="marry"][value="${data.marry}"]`);
                if (radio) radio.checked = true;
            }
            if (has(data.house)) {
                const radio = document.querySelector(`input[name="house"][value="${data.house}"]`);
                if (radio) radio.checked = true;
            }

            if (has(data.educationLevel)) document.querySelector('select[name="educationLevel"]').value = data.educationLevel;
            if (has(data.employmentStatus)) document.querySelector('select[name="employmentStatus"]').value = data.employmentStatus;

            if (has(data.regionSi)) {
                document.getElementById('regionSi').value = data.regionSi;
                updateRegionGu();
                if (has(data.regionGu)) document.getElementById('regionGu').value = data.regionGu;
            }

            if (has(data.income)) {
                const input = document.getElementById('my_income_text');
                input.value = data.income;
                input.dispatchEvent(new Event('input'));
                input.dispatchEvent(new Event('blur'));
            }
            if (has(data.householdIncome)) {
                const input = document.getElementById('household_income_text');
                input.value = data.householdIncome;
                input.dispatchEvent(new Event('input'));
                input.dispatchEvent(new Event('blur'));
            }
        }

        // [수정 3 관련] 더보기 버튼 토글 함수
        function toggleDescription() {
            const desc = document.getElementById('policyDescription');
            const btn = document.getElementById('moreBtn');

            if (desc.classList.contains('line-clamp-3')) {
                desc.classList.remove('line-clamp-3');
                btn.innerHTML = '접기 <i class="fa-solid fa-chevron-up text-[10px]"></i>';
            } else {
                desc.classList.add('line-clamp-3');
                btn.innerHTML = '더보기 <i class="fa-solid fa-chevron-down text-[10px]"></i>';
            }
        }

        // [수정 3 관련] 텍스트 길이에 따라 더보기 버튼 표시 여부 결정
        function checkDescriptionOverflow() {
            const desc = document.getElementById('policyDescription');
            const btn = document.getElementById('moreBtn');

            if (!desc || !btn) return;

            // 실제 내용의 높이가 표시 영역(3줄 높이)보다 큰지 확인
            if (desc.scrollHeight > desc.clientHeight) {
                btn.classList.remove('hidden');
            }
        }

        // [수정 2 관련] 프롬프트 글자수 업데이트 함수
        function updateCharCount(textarea) {
            const count = textarea.value.length;
            document.getElementById('charCount').innerText = `${count}/500자`;
        }

        document.addEventListener("DOMContentLoaded", function() {
            const siSelect = document.getElementById("regionSi");

            for (const si in areaData) {
                const option = document.createElement("option");
                option.value = si;
                option.text = si;
                siSelect.appendChild(option);
            }

            if(siSelect.value) updateRegionGu();

            setupIncomeInput('my_income_range', 'my_income_text');
            setupIncomeInput('household_income_range', 'household_income_text');

            loadPrevConditions();

            checkDescriptionOverflow(); // 더보기 버튼 체크

            // [수정 2 관련] 초기 로드 시 글자수 반영 (뒤로가기 등으로 값 있을 경우)
            const promptArea = document.getElementById('ai_prompt');
            if (promptArea) updateCharCount(promptArea);

            // 폼 전송 시 로딩 모달 띄우기 이벤트 추가
            const form = document.getElementById('simulationForm');
            if (form) {
                form.addEventListener('submit', function() {
                    document.getElementById('loadingModal').classList.remove('hidden');
                    // 스크롤 방지
                    document.body.style.overflow = 'hidden';
                });
            }
        });

    /*]]>*/
</script>

</body>
</html>