<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>PoliSight - ì‹œë®¬ë ˆì´ì…˜ ê¸°ë¡</title>

    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { slate: { 900: '#070F22', 800: '#162133', 700: '#2B394D', 600: '#3F4D61', 500: '#57677E', 400: '#8796AB' } } } }
        }
    </script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .hidden { display: none; }

        /* ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ (result.htmlê³¼ í†µì¼) */
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose strong { color: #1e293b; font-weight: 700; }
        .prose p { margin-bottom: 0.8em; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col min-h-screen">

<th:block th:replace="~{HF :: header('record')}"></th:block>

<main class="flex-grow w-full max-w-5xl mx-auto px-4 py-12">

    <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8">
        <div>
            <h2 class="text-3xl font-bold text-slate-900 mb-2">ì‹œë®¬ë ˆì´ì…˜ ê¸°ë¡ ë³´ê´€ì†Œ</h2>
            <p class="text-slate-500">ì§€ê¸ˆê¹Œì§€ ì§„í–‰í•œ AI ì •ì±… ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”.</p>
        </div>
        <div class="px-5 py-3 bg-white rounded-xl border border-slate-200 shadow-sm flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                <i class="fa-solid fa-file-invoice"></i>
            </div>
            <div>
                <p class="text-xs text-slate-400 font-bold uppercase">ì €ì¥ëœ ê¸°ë¡</p>
                <p class="text-lg font-bold text-slate-800" th:text="${totalCount} + 'ê±´'">0ê±´</p>
            </div>
        </div>
    </div>

    <div class="flex justify-between items-center mb-6">
        <form action="/record" method="get" class="relative">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
            <input type="text" name="keyword" th:value="${param.keyword}" placeholder="ì •ì±…ëª… ê²€ìƒ‰..." class="pl-9 pr-4 py-2 rounded-lg border border-slate-200 text-sm focus:outline-none focus:border-blue-500 w-64 bg-white">
        </form>

        <div class="flex gap-2">
            <button onclick="selectAll()" type="button" class="px-3 py-1.5 border border-slate-200 bg-white rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-50 transition flex items-center gap-1">ì „ì²´ì„ íƒ</button>
            <button onclick="deselectAll()" type="button" class="px-3 py-1.5 border border-slate-200 bg-white rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-50 transition flex items-center gap-1">ì„ íƒí•´ì œ</button>
            <button onclick="openDeleteModal()" type="button" class="px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold hover:bg-red-50 hover:text-red-500 transition flex items-center gap-1">ì‚­ì œ</button>
        </div>
    </div>

    <div class="space-y-4">
        <div th:if="${recordList == null or #lists.isEmpty(recordList)}" class="text-center py-12 bg-white rounded-2xl border border-slate-200 border-dashed">
            <p class="text-slate-400">ì €ì¥ëœ ì‹œë®¬ë ˆì´ì…˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>

        <div th:each="record : ${recordList}"
             class="group bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-all relative overflow-hidden flex items-stretch">

            <div class="absolute top-0 left-0 w-1.5 h-full" th:classappend="${record.suitability == 'Y'} ? 'bg-blue-500' : 'bg-slate-300'"></div>

            <div class="flex items-center pl-5">
                <input type="checkbox" name="recordChk" th:value="${record.simIdx}" class="w-5 h-5 rounded border-slate-300 text-blue-600 cursor-pointer">
            </div>

            <div class="flex-1 p-6 flex flex-col md:flex-row justify-between gap-6">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded" th:text="${#temporals.format(record.createdAt, 'yyyy.MM.dd')}">2026.01.23</span>

                        <span th:if="${record.suitability == 'Y'}" class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded border border-blue-100">ì¡°ê±´ ì¶©ì¡±</span>
                        <span th:unless="${record.suitability == 'Y'}" class="text-xs font-bold text-slate-500 bg-slate-50 px-2 py-0.5 rounded border border-slate-200">ì¡°ê±´ ë¶ˆì¶©ì¡±</span>
                    </div>

                    <h3 class="text-xl font-bold text-slate-800 mb-2 group-hover:text-blue-600 transition" th:text="${record.policyName}">ì •ì±… ì´ë¦„</h3>
                    <p class="text-sm text-slate-500 mb-4 line-clamp-1" th:text="${record.policyIntro}">ì •ì±… ì†Œê°œ</p>

                    <div class="flex items-center gap-6 text-sm text-slate-600">
                        <div class="flex items-center gap-1.5"><i class="fa-solid fa-location-dot text-slate-400"></i><span th:text="${record.regionText}">ì§€ì—­</span></div>
                        <div class="flex items-center gap-1.5"><i class="fa-solid fa-user text-slate-400"></i><span th:text="|ë§Œ ${record.userAge}ì„¸ / ${record.jobName}|">ë‚˜ì´/ì§ì—…</span></div>
                    </div>
                </div>

                <div class="flex md:flex-col justify-end gap-2 min-w-[120px]">
                    <button type="button"
                            th:data-title="${record.policyName}"
                            th:data-content="${record.content}"
                            th:data-suitability="${record.suitability}"
                            th:data-gender="${record.gender}"
                            th:data-age="${record.userAge}"
                            th:data-region="${record.regionText}"
                            th:data-edu="${record.eduLevelCode}"
                            th:data-emp="${record.empStatusCode}"
                            th:data-marry="${record.married}"
                            th:data-family="${record.familySize}"
                            th:data-child="${record.child}"
                            th:data-p-income="${record.personalIncome}"
                            th:data-f-income="${record.familyIncome}"
                            th:data-prompt="${record.prompt}"
                            onclick="openDetailModal(this)"
                            class="w-full px-4 py-2.5 bg-slate-900 text-white text-sm font-bold rounded-xl hover:bg-black transition flex items-center justify-center gap-2 shadow-md">
                        <span>ê²°ê³¼ ë‹¤ì‹œë³´ê¸°</span>
                        <i class="fa-solid fa-chevron-right text-xs"></i>
                    </button>
                    <button type="button" th:onclick="|deleteSingle(${record.simIdx})|" class="w-full px-4 py-2.5 bg-white border border-slate-200 text-slate-500 text-sm font-bold rounded-xl hover:bg-red-50 hover:text-red-500 transition">ì‚­ì œ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex justify-center mt-12" th:if="${totalPages > 0}">
        <nav class="flex gap-1">
            <a th:href="@{/record(page=${currentPage - 1}, keyword=${param.keyword})}" th:classappend="${currentPage == 1} ? 'pointer-events-none opacity-50' : ''" class="w-10 h-10 flex items-center justify-center rounded-lg border border-slate-200 bg-white text-slate-500"><i class="fa-solid fa-chevron-left text-xs"></i></a>
            <th:block th:each="page : ${#numbers.sequence(startPage, endPage)}">
                <a th:href="@{/record(page=${page}, keyword=${param.keyword})}" th:text="${page}" th:classappend="${page == currentPage} ? 'border-slate-900 bg-slate-900 text-white' : 'border-slate-200 bg-white text-slate-600'" class="w-10 h-10 flex items-center justify-center rounded-lg border font-bold transition">1</a>
            </th:block>
            <a th:href="@{/record(page=${currentPage + 1}, keyword=${param.keyword})}" th:classappend="${currentPage == totalPages} ? 'pointer-events-none opacity-50' : ''" class="w-10 h-10 flex items-center justify-center rounded-lg border border-slate-200 bg-white text-slate-500"><i class="fa-solid fa-chevron-right text-xs"></i></a>
        </nav>
    </div>

</main>

<th:block th:replace="~{HF :: footer}"></th:block>

<div id="detail-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeDetailModal()"></div>
    <div class="relative bg-white w-full max-w-7xl h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col transform transition-all">

        <div class="px-8 py-6 border-b border-slate-100 flex-shrink-0 bg-white z-10 flex justify-between items-center">
            <div>
                <span class="text-sm font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full border border-blue-100 mb-1 inline-block">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> AI Analysis Report (History)
                </span>
                <h2 class="text-2xl font-bold text-slate-900">ì‹œë®¬ë ˆì´ì…˜ ë¶„ì„ ê²°ê³¼</h2>
            </div>
            <button onclick="closeDetailModal()" class="text-slate-400 hover:text-slate-700 transition p-2 rounded-full hover:bg-slate-100">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
        </div>

        <div class="flex-grow overflow-y-auto custom-scroll p-8 bg-slate-50">
            <div class="grid lg:grid-cols-12 gap-8">

                <aside class="lg:col-span-4 space-y-6">
                    <div class="bg-white rounded-2xl border border-blue-100 shadow-sm p-6 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4 z-0"></div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 text-sm text-blue-600 font-bold mb-4">
                                <i class="fa-solid fa-crosshairs"></i> ë¶„ì„ ëŒ€ìƒ ì •ì±…
                            </div>
                            <h4 id="modal-policy-name" class="font-bold text-xl text-slate-900 leading-tight">-</h4>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                        <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wide mb-6">ë¶„ì„ ì¡°ê±´</h3>
                        <div class="space-y-6 divide-y divide-slate-100">
                            <div class="pt-0">
                                <h4 class="text-xs font-bold text-slate-400 mb-3">ê¸°ë³¸ ì¸ì  ì‚¬í•­</h4>
                                <ul class="space-y-2 text-sm">
                                    <li class="flex justify-between"><span class="text-slate-500">ì„±ë³„</span><span id="cond-gender" class="font-bold text-slate-800">-</span></li>
                                    <li class="flex justify-between"><span class="text-slate-500">ë‚˜ì´</span><span id="cond-age" class="font-bold text-blue-600">-</span></li>
                                    <li class="flex justify-between"><span class="text-slate-500">ê±°ì£¼ì§€</span><span id="cond-region" class="font-bold text-slate-800">-</span></li>
                                </ul>
                            </div>
                            <div class="pt-4">
                                <h4 class="text-xs font-bold text-slate-400 mb-3">ì‚¬íšŒì  ìƒíƒœ</h4>
                                <ul class="space-y-2 text-sm">
                                    <li class="flex justify-between"><span class="text-slate-500">í•™ë ¥</span><span id="cond-edu" class="font-bold text-slate-800">-</span></li>
                                    <li class="flex justify-between"><span class="text-slate-500">ê³ ìš©</span><span id="cond-emp" class="font-bold text-blue-600">-</span></li>
                                </ul>
                            </div>
                            <div class="pt-4">
                                <h4 class="text-xs font-bold text-slate-400 mb-3">ê°€êµ¬ ë° ê²½ì œ</h4>
                                <ul class="space-y-2 text-sm">
                                    <li class="flex justify-between"><span class="text-slate-500">ê²°í˜¼</span><span id="cond-marry" class="font-bold text-slate-800">-</span></li>
                                    <li class="flex justify-between"><span class="text-slate-500">ìë…€</span><span id="cond-child" class="font-bold text-slate-800">-</span></li>
                                    <li class="flex justify-between"><span class="text-slate-500">ë³¸ì¸ì†Œë“</span><span id="cond-p-income" class="font-bold text-slate-800">-</span></li>
                                    <li class="flex justify-between"><span class="text-slate-500">ê°€êµ¬ì†Œë“</span><span id="cond-f-income" class="font-bold text-slate-800">-</span></li>
                                </ul>
                            </div>
                            <div class="pt-6">
                                <h4 class="font-bold text-sm text-slate-800 mb-3 flex items-center gap-2">
                                    <span class="w-2.5 h-2.5 bg-indigo-600 rounded-full"></span> AI ì •ë°€ ë¶„ì„ ìš”ì²­ì‚¬í•­
                                </h4>
                                <div class="bg-indigo-50/60 rounded-xl p-3 border border-indigo-100">
                                    <p id="cond-prompt" class="text-sm text-indigo-900 leading-relaxed font-medium break-keep">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>

                <section class="lg:col-span-8 space-y-8">
                    <div id="modal-result-card" class="rounded-2xl border shadow-lg overflow-hidden transition-all duration-500">
                        <div id="modal-header-bg" class="p-8 text-white relative overflow-hidden">
                            <div class="absolute right-0 top-0 w-64 h-64 bg-white/10 rounded-full -mr-16 -mt-16 blur-3xl"></div>
                            <div class="relative z-10 flex items-center justify-between">
                                <div>
                                    <div class="flex items-center gap-2 mb-2 opacity-90 text-sm font-medium">AI Policy Analyst</div>
                                    <h2 id="modal-suitability-text" class="text-3xl font-bold leading-normal">-</h2>
                                </div>
                                <div id="modal-status-badge" class="bg-white/20 px-4 py-2 rounded-full text-lg font-bold border border-white/30 backdrop-blur-sm">-</div>
                            </div>
                        </div>
                        <div class="p-8 bg-white">
                            <h3 class="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2">
                                <i id="modal-quote-icon" class="fa-solid fa-quote-left"></i> AI ìƒë‹´ì‚¬ì˜ ë§ì¶¤í˜• ê°€ì´ë“œ
                            </h3>
                            <div id="modal-ai-guide" class="bg-slate-50 rounded-xl p-6 border border-slate-200 text-slate-700 leading-relaxed text-sm shadow-inner prose prose-sm max-w-none">
                                <div class="flex flex-col items-center justify-center py-10 text-slate-400">
                                    <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i><span>ë°ì´í„° ë¡œë”© ì¤‘...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600 text-sm"><i class="fa-solid fa-arrow-trend-up"></i></div>
                            ë¯¸ë˜ ì‹œë®¬ë ˆì´ì…˜ ì‹œë‚˜ë¦¬ì˜¤
                        </h3>
                        <div id="modal-scenarios" class="space-y-3"></div>
                    </div>

                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600 text-sm"><i class="fa-solid fa-thumbs-up"></i></div>
                            ì¶”ì²œ ë° ê´€ë ¨ ì •ì±…
                        </h3>
                        <div class="bg-slate-50 rounded-xl p-5 border border-slate-200 shadow-inner">
                            <ul id="modal-recommendations" class="space-y-3"></ul>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-slate-600 text-sm"><i class="fa-solid fa-scale-balanced"></i></div>
                            AI ë¶„ì„ ê·¼ê±° ë°ì´í„°
                        </h3>
                        <div id="modal-evidence" class="space-y-3"></div>
                    </div>
                </section>
            </div>
        </div>

        <div class="border-t border-slate-100 p-6 bg-white flex justify-end flex-shrink-0 z-10">
            <button onclick="closeDetailModal()" class="px-6 py-3 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-900 transition shadow-lg">í™•ì¸ ë° ë‹«ê¸°</button>
        </div>
    </div>
</div>

<div id="delete-modal" class="fixed inset-0 z-[120] hidden flex items-center justify-center" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onclick="closeDeleteModal()"></div>
    <div class="relative bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 text-center transform scale-95 opacity-0 transition-all duration-200" id="delete-content">
        <div class="w-12 h-12 rounded-full bg-red-100 text-red-500 flex items-center justify-center mx-auto mb-4 text-xl">
            <i class="fa-solid fa-trash-can"></i>
        </div>
        <h3 class="text-lg font-bold text-slate-900 mb-2">ê¸°ë¡ ì‚­ì œ</h3>
        <p class="text-sm text-slate-500 mb-6 leading-relaxed">ì„ íƒí•œ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì‚­ì œ í›„ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        <div class="flex gap-3">
            <button onclick="closeDeleteModal()" class="flex-1 py-3 border border-slate-200 bg-white text-slate-600 font-bold rounded-xl hover:bg-slate-50 transition text-sm">ì·¨ì†Œ</button>
            <button onclick="confirmDelete()" class="flex-1 py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition text-sm shadow-md">ì‚­ì œ</button>
        </div>
    </div>
</div>

<script th:inline="javascript">
    // --- ìœ í‹¸ë¦¬í‹° ë§µí•‘ ---
    const eduMap = { "001": "ì¤‘ì¡¸ ì´í•˜", "004": "ê³ ì¡¸", "007": "ëŒ€ì¡¸", "default": "ê¸°íƒ€" };
    const empMap = { "UNEMPLOYED": "ë¯¸ì·¨ì—…", "EMPLOYED": "ì¬ì§ì¤‘", "default": "ê¸°íƒ€" };

    // --- ê¸°ë³¸ ê¸°ëŠ¥ ---
    function selectAll() { document.querySelectorAll('input[name="recordChk"]').forEach(cb => cb.checked = true); }
    function deselectAll() { document.querySelectorAll('input[name="recordChk"]').forEach(cb => cb.checked = false); }
    function closeDetailModal() { document.getElementById('detail-modal').classList.add('hidden'); }

    // --- â˜… ìƒì„¸ ëª¨ë‹¬ ì—´ê¸° ---
    function openDetailModal(btn) {
        // (1) ì¡°ê±´ ë°ì´í„° ì±„ìš°ê¸°
        document.getElementById('modal-policy-name').innerText = btn.getAttribute('data-title');

        document.getElementById('cond-gender').innerText = (btn.getAttribute('data-gender') === 'male' || btn.getAttribute('data-gender') === 'M') ? 'ë‚¨ì„±' : 'ì—¬ì„±';
        document.getElementById('cond-age').innerText = btn.getAttribute('data-age') + 'ì„¸';
        document.getElementById('cond-region').innerText = btn.getAttribute('data-region') || '-';

        const eduCode = btn.getAttribute('data-edu');
        document.getElementById('cond-edu').innerText = eduMap[eduCode] || eduMap.default;

        const empCode = btn.getAttribute('data-emp');
        let empText = 'ê¸°íƒ€';
        if(empCode === '1' || empCode === 'UNEMPLOYED') empText = 'ë¯¸ì·¨ì—…';
        else if(empCode === '2' || empCode === 'EMPLOYED') empText = 'ì¬ì§ì¤‘';
        document.getElementById('cond-emp').innerText = empText;

        document.getElementById('cond-marry').innerText = (btn.getAttribute('data-marry') === 'true' || btn.getAttribute('data-marry') === '1') ? 'ê¸°í˜¼' : 'ë¯¸í˜¼';
        document.getElementById('cond-child').innerText = (btn.getAttribute('data-child') || '0') + 'ëª…';

        const pIncome = parseInt(btn.getAttribute('data-p-income')) || 0;
        const fIncome = parseInt(btn.getAttribute('data-f-income')) || 0;
        document.getElementById('cond-p-income').innerText = pIncome.toLocaleString() + ' ë§Œì›';
        document.getElementById('cond-f-income').innerText = fIncome.toLocaleString() + ' ë§Œì›';

        document.getElementById('cond-prompt').innerText = btn.getAttribute('data-prompt') || 'ì¶”ê°€ ìš”ì²­ì‚¬í•­ ì—†ìŒ';

        // (2) AI ê²°ê³¼ ë Œë”ë§
        const rawContent = btn.getAttribute('data-content');
        const suitability = btn.getAttribute('data-suitability');

        try {
            const data = JSON.parse(rawContent);
            const isPass = (suitability === 'Y');

            renderHeaderAndGuide(data, isPass);
            toggleSection('modal-scenarios', data.scenarios, renderScenarios);
            toggleSection('modal-recommendations', data.recommendations, renderRecommendations);
            toggleSection('modal-evidence', data.evidence, renderEvidence);

        } catch (e) {
            // êµ¬ë²„ì „ ë°ì´í„° ì²˜ë¦¬
            fallbackToTextMode(rawContent);
        }
        document.getElementById('detail-modal').classList.remove('hidden');
    }

    // í—¤ë” ìŠ¤íƒ€ì¼ë§ ë° ê°€ì´ë“œ ë Œë”ë§
    function renderHeaderAndGuide(data, isPass) {
        const bg = document.getElementById('modal-header-bg');
        const text = document.getElementById('modal-suitability-text');
        const badge = document.getElementById('modal-status-badge');
        const icon = document.getElementById('modal-quote-icon');

        if (isPass) {
            bg.className = "p-8 text-white relative overflow-hidden bg-gradient-to-r from-blue-600 to-indigo-600";
            text.innerText = "ì¶•í•˜í•©ë‹ˆë‹¤! ì‹ ì²­ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
            badge.innerHTML = '<i class="fa-solid fa-check-circle mr-2"></i>PASS';
            icon.className = "fa-solid fa-quote-left text-blue-500";
        } else {
            bg.className = "p-8 text-white relative overflow-hidden bg-gradient-to-r from-red-500 to-orange-500";
            text.innerText = "ì•„ì‰½ì§€ë§Œ ì‹ ì²­ì´ ì–´ë µìŠµë‹ˆë‹¤.";
            badge.innerHTML = '<i class="fa-solid fa-circle-exclamation mr-2"></i>FAIL';
            icon.className = "fa-solid fa-quote-left text-red-500";
        }

        let guide = data.content || "";
        if (data.answer) guide += "\n\n" + data.answer;
        document.getElementById('modal-ai-guide').innerHTML = marked.parse(guide);
    }

    // ì„¹ì…˜ í† ê¸€
    function toggleSection(elementId, data, renderFunc) {
        const container = document.getElementById(elementId);
        const parentCard = container.parentElement;
        if (!data || data.length === 0) {
            parentCard.classList.add('hidden');
        } else {
            parentCard.classList.remove('hidden');
            renderFunc(data);
        }
    }

    // ì‹œë‚˜ë¦¬ì˜¤ ë Œë”ë§
    function renderScenarios(scenarios) {
        const container = document.getElementById('modal-scenarios');
        container.innerHTML = '';
        scenarios.forEach(s => {
            const styles = {
                'risk': { bg: 'bg-amber-50', border: 'border-amber-200', icon: 'fa-triangle-exclamation text-amber-500' },
                'benefit': { bg: 'bg-blue-50', border: 'border-blue-200', icon: 'fa-rocket text-blue-500' },
                'solution': { bg: 'bg-emerald-50', border: 'border-emerald-200', icon: 'fa-lightbulb text-emerald-500' },
                'roadmap': { bg: 'bg-purple-50', border: 'border-purple-200', icon: 'fa-map-location-dot text-purple-500' }
            };
            const style = styles[s.type] || { bg: 'bg-slate-50', border: 'border-slate-200', icon: 'fa-info-circle text-slate-400' };
            const div = document.createElement('div');
            div.className = `rounded-xl p-4 border transition-all ${style.bg} ${style.border}`;
            div.innerHTML = `<div class="flex items-start gap-3"><div class="mt-0.5 text-lg"><i class="fa-solid ${style.icon}"></i></div><div class="flex-1"><h4 class="font-bold text-sm mb-1 text-slate-900">${s.title}</h4><p class="text-sm text-slate-700 leading-relaxed">${s.content}</p></div></div>`;
            container.appendChild(div);
        });
    }

    // ì¶”ì²œ ì •ì±… ë Œë”ë§
    function renderRecommendations(recs) {
        const container = document.getElementById('modal-recommendations');
        container.innerHTML = '';
        recs.forEach(r => {
            const li = document.createElement('li');
            li.className = "flex flex-col p-3 bg-white rounded-lg border border-slate-100 hover:border-blue-200 transition";
            li.innerHTML = `<div class="flex justify-between items-center mb-1"><strong class="text-slate-800 text-sm">ğŸ”— ${r.name}</strong></div><p class="text-xs text-slate-500 pl-4">${r.reason}</p>`;
            container.appendChild(li);
        });
    }

    // ê·¼ê±° ë°ì´í„° ë Œë”ë§
    function renderEvidence(evidence) {
        const container = document.getElementById('modal-evidence');
        container.innerHTML = '';
        evidence.forEach(e => {
            let badgeClass = e.type === 'ë²•ë ¹' ? "bg-blue-100 text-blue-700" : "bg-orange-100 text-orange-700";
            const div = document.createElement('div');
            div.className = "bg-white border border-slate-200 rounded-xl p-4 shadow-sm";
            div.innerHTML = `<div class="flex items-center gap-2 mb-2"><span class="${badgeClass} px-2 py-1 rounded text-xs font-bold">${e.type}</span><span class="font-bold text-slate-700 text-sm">${e.title}</span></div><div class="bg-slate-50 p-2 rounded text-xs text-slate-600"><span class="text-blue-600 font-bold mr-1">âœ”</span><span>${e.matchInfo}</span></div>`;
            container.appendChild(div);
        });
    }

    function fallbackToTextMode(text) {
        const bg = document.getElementById('modal-header-bg');
        bg.className = "p-8 text-white relative overflow-hidden bg-gradient-to-r from-slate-500 to-slate-600";
        document.getElementById('modal-suitability-text').innerText = "ë¶„ì„ ê²°ê³¼ (êµ¬ë²„ì „)";
        document.getElementById('modal-status-badge').innerText = "RECORD";
        document.getElementById('modal-ai-guide').innerText = text;
        document.getElementById('modal-scenarios').parentElement.classList.add('hidden');
        document.getElementById('modal-recommendations').parentElement.classList.add('hidden');
        document.getElementById('modal-evidence').parentElement.classList.add('hidden');
    }

    // ==========================================
    // 4. â˜… ì‚­ì œ ê¸°ëŠ¥ (ë³µêµ¬ë¨!)
    // ==========================================
    let deleteTargetIds = [];

    // [ì‚­ì œ] ë²„íŠ¼ í´ë¦­ ì‹œ (ì²´í¬ë°•ìŠ¤ í™•ì¸)
    function openDeleteModal() {
        const checkedBoxes = document.querySelectorAll('input[name="recordChk"]:checked');
        deleteTargetIds = Array.from(checkedBoxes).map(cb => cb.value);

        if (deleteTargetIds.length === 0) {
            alert("ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }
        showDeleteModal();
    }

    // ê°œë³„ [ì‚­ì œ] ë²„íŠ¼ í´ë¦­ ì‹œ
    function deleteSingle(id) {
        deleteTargetIds = [id];
        showDeleteModal();
    }

    // ì‚­ì œ ëª¨ë‹¬ ë„ìš°ê¸° (ì• ë‹ˆë©”ì´ì…˜)
    function showDeleteModal() {
        const modal = document.getElementById('delete-modal');
        const content = document.getElementById('delete-content');
        modal.classList.remove('hidden');
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    // ì‚­ì œ ëª¨ë‹¬ ë‹«ê¸°
    function closeDeleteModal() {
        const modal = document.getElementById('delete-modal');
        const content = document.getElementById('delete-content');
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 200);
    }

    // ìµœì¢… ì‚­ì œ ì‹¤í–‰ (ì„œë²„ í†µì‹ )
    function confirmDelete() {
        if(deleteTargetIds.length === 0) return;

        fetch('/api/record/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(deleteTargetIds)
        })
        .then(response => {
            if (response.ok) {
                alert('ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            } else {
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => {
            closeDeleteModal();
        });
    }

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            closeDetailModal();
            closeDeleteModal();
        }
    });
</script>
</body>
</html>