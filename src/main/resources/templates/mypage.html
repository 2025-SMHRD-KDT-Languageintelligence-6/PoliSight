<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoliSight - 마이페이지</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { width: 4px; }
        .scrollbar-hide::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-hide::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #2563EB; cursor: pointer; margin-top: -6px;
            box-shadow: 0 0 0 3px #fff, 0 0 0 4px rgba(37, 99, 235, 0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #E2E8F0; border-radius: 2px;
        }

        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 14px;
            padding-right: 30px;
        }

        .border-red-500 { border-color: #ef4444 !important; }
        .text-red-500 { color: #ef4444 !important; }
        .hidden { display: none; }

        .modal-enter { animation: fadeIn 0.2s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.2s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col min-h-screen">

<th:block th:replace="~{HF :: header('mypage')}"></th:block>

<main class="flex-grow max-w-7xl mx-auto px-4 py-12 w-full grid lg:grid-cols-12 gap-8">

    <aside class="lg:col-span-3">
        <div class="sticky top-24 space-y-6">
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm text-center">
                <div class="w-24 h-24 rounded-full bg-slate-200 mx-auto mb-4 overflow-hidden border-4 border-white shadow-lg flex items-center justify-center">
                    <i class="fa-solid fa-user text-4xl text-slate-400"></i>
                </div>

                <div class="flex items-center justify-center gap-2 mb-1">
                    <h2 class="text-xl font-bold text-slate-900" th:text="${session.loginMember.memberName}">사용자</h2>
                    <button type="button" onclick="openNameChangeModal()" class="text-slate-400 hover:text-blue-600 transition p-1" title="이름 변경">
                        <i class="fa-solid fa-arrows-rotate text-sm"></i>
                    </button>
                </div>

                <p class="text-sm text-slate-500" th:text="${session.loginMember.email}">user@email.com</p>
            </div>

            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <nav class="flex flex-col">
                    <a href="#conditions" class="px-6 py-4 text-sm font-bold text-slate-700 hover:bg-slate-50 border-l-4 border-blue-600 bg-blue-50/50 flex items-center gap-3">
                        <i class="fa-solid fa-sliders w-5 text-center"></i> 내 조건 관리
                    </a>
                    <a href="#favorites" class="px-6 py-4 text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-blue-600 border-l-4 border-transparent transition flex items-center gap-3">
                        <i class="fa-solid fa-bookmark w-5 text-center"></i> 즐겨찾기 및 알림
                    </a>
                    <a href="#account" class="px-6 py-4 text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-blue-600 border-l-4 border-transparent transition flex items-center gap-3">
                        <i class="fa-solid fa-key w-5 text-center"></i> 비밀번호 수정
                    </a>
                </nav>
            </div>
        </div>
    </aside>

    <section class="lg:col-span-9 space-y-10">
        <div id="conditions" class="scroll-mt-24">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900">내 조건 관리</h2>
                <button onclick="openSetupModal()" class="text-lg text-blue-600 font-bold hover:underline transition flex items-center gap-1 group">
                    <i class="fa-solid fa-pen-to-square group-hover:scale-110 transition-transform"></i> 전체 수정
                </button>
            </div>
            <div class="bg-white rounded-2xl border border-blue-100 shadow-sm overflow-hidden">
                <div class="bg-gradient-to-r from-slate-50 to-white p-6 border-b border-slate-100">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center text-xl shadow-inner"><i class="fa-solid fa-filter"></i></div>
                        <div>
                            <h3 class="font-bold text-lg text-slate-800">맞춤 정책 필터 데이터</h3>
                            <p class="text-sm text-slate-500">맞춤 정책 검색을 위한 필터 데이터입니다. (이제 DB에 저장됩니다)</p>
                        </div>
                    </div>
                </div>
                <div class="p-8 grid md:grid-cols-2 gap-y-8 gap-x-12">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-400 uppercase">기본 정보</label>
                        <div class="flex items-center justify-between py-2 border-b border-slate-100">
                            <span class="text-slate-600">성별 / 생년월일</span>
                            <span class="font-bold text-slate-800" id="view-basic">-</span>
                        </div>
                        <div class="flex items-center justify-between py-2 border-b border-slate-100">
                            <span class="text-slate-600">거주지역</span>
                            <span class="font-bold text-slate-800" id="view-region">-</span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-400 uppercase">사회적 상태</label>
                        <div class="flex items-center justify-between py-2 border-b border-slate-100">
                            <span class="text-slate-600">최종 학력</span>
                            <span class="font-bold text-slate-800" id="view-edu">-</span>
                        </div>
                        <div class="flex items-center justify-between py-2 border-b border-slate-100">
                            <span class="text-slate-600">고용 / 사업자</span>
                            <span class="font-bold text-slate-800" id="view-job">-</span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-400 uppercase">가족 및 주거</label>
                        <div class="flex items-center justify-between py-2 border-b border-slate-100">
                            <span class="text-slate-600">결혼 / 자녀</span>
                            <span class="font-bold text-slate-800" id="view-family">-</span>
                        </div>
                        <div class="flex items-center justify-between py-2 border-b border-slate-100">
                            <span class="text-slate-600">주택 소유 / 가구원</span>
                            <span class="font-bold text-slate-800" id="view-house">-</span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-400 uppercase">경제 정보 (월 소득)</label>
                        <div class="flex items-center justify-between py-2 border-b border-slate-100">
                            <span class="text-slate-600">본인 소득</span>
                            <span class="font-bold text-blue-600" id="view-myIncome">0만원</span>
                        </div>
                        <div class="flex items-center justify-between py-2 border-b border-slate-100">
                            <span class="text-slate-600">가구 합산 소득</span>
                            <span class="font-bold text-slate-800" id="view-hhIncome">0만원</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr class="border-slate-200">

        <div id="favorites" class="scroll-mt-24">
            <h2 class="text-2xl font-bold text-slate-900 mb-6">즐겨찾기 및 알림 관리</h2>
            <div class="bg-slate-50 p-8 rounded-xl text-center border border-slate-200 border-dashed text-slate-400">
                <i class="fa-regular fa-bookmark text-2xl mb-2"></i>
                <p class="text-sm">즐겨찾기한 정책이 여기에 표시됩니다.</p>
            </div>
        </div>

        <hr class="border-slate-200">

        <div id="account" class="scroll-mt-24">
            <h2 class="text-2xl font-bold text-slate-900 mb-6">비밀번호 수정</h2>
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-8">
                <form action="/updatePassword" method="post" onsubmit="return validateForm()">

                    <div th:if="${session.loginMember.provider == 'PoliSight'}">
                        <div class="text-center mb-8">
                            <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-600 mb-3">
                                <i class="fa-solid fa-shield-halved text-xl"></i>
                            </div>
                            <h3 class="text-lg font-bold text-slate-800">안전한 정보 보호</h3>
                            <p class="text-sm text-slate-500">주기적인 비밀번호 변경으로 계정을 안전하게 보호하세요.</p>
                        </div>

                        <div class="space-y-5 max-w-lg mx-auto">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">현재 비밀번호</label>
                                <input type="password" name="currentPw" required placeholder="현재 비밀번호를 입력해 주세요"
                                       class="w-full p-3 rounded-xl border border-slate-200 bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm transition">
                            </div>

                            <div class="space-y-4 pt-2 border-t border-slate-100">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-2">새 비밀번호</label>
                                    <input type="password" id="newPw" name="newPw" required placeholder="6~20자 (영문/숫자/특수문자 포함)"
                                           class="w-full p-3 rounded-xl border border-slate-200 bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm transition">
                                    <p id="pwRuleError" class="text-xs text-red-500 mt-1 hidden font-medium">* 영문/숫자/특수문자 포함 6~20자로 입력해 주세요.</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-2">새 비밀번호 확인</label>
                                    <input type="password" id="newPwConfirm" required placeholder="새로운 비밀번호 확인"
                                           class="w-full p-3 rounded-xl border border-slate-200 bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm transition">
                                    <p id="pwMatchMsg" class="text-xs text-red-500 mt-1 hidden font-medium">* 비밀번호가 일치하지 않습니다.</p>
                                </div>
                            </div>

                            <div class="pt-4">
                                <button type="submit" class="w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-black transition text-sm shadow-md flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-check"></i> 비밀번호 변경하기
                                </button>
                            </div>
                        </div>
                    </div>

                    <div th:unless="${session.loginMember.provider == 'PoliSight'}"
                         class="bg-slate-50 p-10 rounded-xl border border-slate-200 text-center flex flex-col items-center justify-center min-h-[300px]">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-200 text-slate-500 mb-4 shadow-sm">
                            <i class="fa-solid fa-lock text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-1">비밀번호 변경 불가</h3>
                        <p class="text-sm text-slate-500 mb-6">
                            현재 회원님은 <span class="font-bold text-blue-600" th:text="${session.loginMember.provider}">Social</span> 계정으로 로그인 중입니다.<br>
                            비밀번호 변경 및 계정 관리는 해당 소셜 서비스에서 가능합니다.
                        </p>
                        <div class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-xs text-slate-400 font-medium">
                            <i class="fa-solid fa-circle-info mr-1"></i> 소셜 연동 계정은 PoliSight 내에서 비밀번호를 관리하지 않습니다.
                        </div>
                    </div>

                </form>
            </div>
        </div>

    </section>
</main>

<th:block th:replace="~{HF :: footer}"></th:block>

<!-- ✅ 서버 메시지 모달 -->
<div id="alert-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onclick="closeAlertModal()"></div>
    <div class="relative bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 text-center transform scale-95 opacity-0 transition-all duration-200" id="alert-content">
        <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mx-auto mb-4 text-xl">
            <i class="fa-solid fa-circle-info"></i>
        </div>
        <h3 class="text-lg font-bold text-slate-800 mb-2">알림</h3>
        <p class="text-sm text-slate-500 mb-6 leading-relaxed" id="alert-msg">메시지 내용</p>
        <button onclick="closeAlertModal()" class="w-full py-3 bg-slate-900 text-white font-bold rounded-xl hover:bg-black transition text-sm">확인</button>
    </div>
</div>

<!-- 이름 변경 모달 -->
<div id="name-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeNameChangeModal()"></div>
    <div class="relative bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 opacity-0 transition-all duration-200" id="name-content">
        <div class="flex justify-between items-center mb-5">
            <h3 class="text-lg font-bold text-slate-900">이름 변경</h3>
            <button onclick="closeNameChangeModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
        </div>

        <form action="/updateName" method="post" onsubmit="return validateNameChange()">
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-500 mb-1.5">새로운 이름</label>
                <input type="text" id="newNameInput" name="userName" class="w-full p-3 rounded-xl border border-slate-200 focus:outline-none focus:border-blue-500 font-bold text-slate-800" placeholder="변경할 이름을 입력하세요">
            </div>
            <div class="flex gap-3">
                <button type="button" onclick="closeNameChangeModal()" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold text-slate-600 hover:bg-slate-50 transition text-sm">취소</button>
                <button type="submit" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition text-sm shadow-md">변경하기</button>
            </div>
        </form>
    </div>
</div>

<!-- ✅ 조건 설정 모달 -->
<div id="setup-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeSetupModal()"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 w-full max-w-2xl border border-slate-200">

                <div class="bg-white px-6 py-5 border-b border-slate-100 flex justify-between items-center sticky top-0 z-10">
                    <div>
                        <h3 class="text-xl font-bold text-slate-900">맞춤 조건 설정</h3>
                        <p class="text-xs text-slate-500 mt-1">저장 시 DB(member 테이블)에 반영됩니다.</p>
                    </div>
                    <button type="button" onclick="closeSetupModal()" class="text-slate-400 hover:text-slate-600 transition p-2 bg-slate-50 rounded-full">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>

                <div class="p-6 space-y-8 max-h-[70vh] overflow-y-auto custom-scroll">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-sm font-bold text-slate-800 mb-3">성별</h4>
                            <div class="flex bg-slate-100 p-1 rounded-xl">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="modal-gender" value="M" class="peer sr-only">
                                    <span class="block text-center py-2 text-sm font-bold text-slate-500 rounded-lg peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm transition-all">남성</span>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="modal-gender" value="F" class="peer sr-only">
                                    <span class="block text-center py-2 text-sm font-bold text-slate-500 rounded-lg peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm transition-all">여성</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-slate-800 mb-3">생년월일</h4>
                            <input type="text" id="modal-birthDate" placeholder="YYYY-MM-DD 또는 YYYYMMDD" maxlength="10"
                                   class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 focus:outline-none focus:border-blue-500 text-sm font-medium">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-sm font-bold text-slate-800 mb-3">거주 지역 (시/도)</h4>
                            <select id="modal-regionSi" onchange="updateModalRegionGu()"
                                    class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 focus:outline-none focus:border-blue-500 text-sm custom-select">
                                <option value="">시/도 선택</option>
                            </select>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-slate-800 mb-3">거주 지역 (시/군/구)</h4>
                            <select id="modal-regionGu"
                                    class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 focus:outline-none focus:border-blue-500 text-sm custom-select">
                                <option value="">시/군/구 선택</option>
                            </select>
                        </div>
                    </div>

                    <hr class="border-slate-100">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-sm font-bold text-slate-800 mb-3">최종 학력</h4>
                            <select id="modal-educationLevel"
                                    class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 focus:outline-none focus:border-blue-500 text-sm custom-select">
                                <option value="">선택</option>
                                <option value="1">고졸 미만</option>
                                <option value="2">고등학교 졸업</option>
                                <option value="3">대학교 재학/휴학</option>
                                <option value="4">대학교 졸업 (예정)</option>
                                <option value="5">석/박사 (과정/졸업)</option>
                            </select>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-slate-800 mb-3">고용 상태</h4>
                            <select id="modal-employmentStatus"
                                    class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 focus:outline-none focus:border-blue-500 text-sm custom-select">
                                <option value="">선택</option>
                                <option value="1">미취업 (구직자)</option>
                                <option value="2">직장인 (계약/정규직)</option>
                                <option value="3">자영업 / 프리랜서</option>
                                <option value="4">학생</option>
                            </select>
                            <div class="mt-2 flex items-center gap-2">
                                <input type="checkbox" id="modal-bizCheck" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                                <label for="modal-bizCheck" class="text-xs font-bold text-slate-600 cursor-pointer">사업자 등록증 보유</label>
                            </div>
                        </div>
                    </div>

                    <hr class="border-slate-100">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-sm font-bold text-slate-800 mb-3">결혼 여부</h4>
                            <div class="flex bg-slate-100 p-1 rounded-xl">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="modal-marry" value="false" class="peer sr-only">
                                    <span class="block text-center py-2 text-sm font-bold text-slate-500 rounded-lg peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm transition-all">미혼</span>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="modal-marry" value="true" class="peer sr-only">
                                    <span class="block text-center py-2 text-sm font-bold text-slate-500 rounded-lg peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm transition-all">기혼</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-slate-800 mb-3">자녀 수 (명)</h4>
                            <input type="number" id="modal-childCount" min="0" value="0"
                                   class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 focus:outline-none focus:border-blue-500 text-sm font-medium text-right">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-sm font-bold text-slate-800 mb-3">주택 소유</h4>
                            <div class="flex bg-slate-100 p-1 rounded-xl">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="modal-house" value="false" class="peer sr-only">
                                    <span class="block text-center py-2 text-sm font-bold text-slate-500 rounded-lg peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm transition-all">미소유</span>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="modal-house" value="true" class="peer sr-only">
                                    <span class="block text-center py-2 text-sm font-bold text-slate-500 rounded-lg peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm transition-all">소유</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-slate-800 mb-3">가구원 수 (명)</h4>
                            <input type="number" id="modal-familyCount" min="1" value="1"
                                   class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 focus:outline-none focus:border-blue-500 text-sm font-medium text-right">
                        </div>
                    </div>

                    <hr class="border-slate-100">

                    <div>
                        <h4 class="text-sm font-bold text-slate-800 mb-3">본인 월 소득 (세전)</h4>
                        <div class="bg-slate-50 border border-slate-200 rounded-xl p-3 mb-2 flex items-center gap-2">
                            <input type="number" id="modal-myIncomeText" class="flex-1 min-w-0 bg-transparent font-bold text-slate-800 text-sm focus:outline-none text-right" placeholder="0">
                            <span class="text-xs font-bold text-slate-500">만원</span>
                        </div>
                        <input type="range" id="modal-myIncomeSlider" min="0" max="600" step="10" value="0" class="w-full">
                    </div>

                    <div>
                        <h4 class="text-sm font-bold text-slate-800 mb-3">가구 합산 월 소득 (세전)</h4>
                        <div class="bg-slate-50 border border-slate-200 rounded-xl p-3 mb-2 flex items-center gap-2">
                            <input type="number" id="modal-hhIncomeText" class="flex-1 min-w-0 bg-transparent font-bold text-slate-800 text-sm focus:outline-none text-right" placeholder="0">
                            <span class="text-xs font-bold text-slate-500">만원</span>
                        </div>
                        <input type="range" id="modal-hhIncomeSlider" min="0" max="1000" step="10" value="0" class="w-full">
                    </div>
                </div>

                <div class="bg-slate-50 px-6 py-4 flex justify-end gap-3 border-t border-slate-100 sticky bottom-0 z-10">
                    <button type="button" onclick="closeSetupModal()" class="px-5 py-3 rounded-xl border border-slate-300 bg-white font-bold text-slate-600 hover:bg-slate-50 transition text-sm">취소</button>
                    <button type="button" onclick="saveConditions()" class="px-5 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200 text-sm">변경사항 저장</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ✅ hidden form: DB 저장용 -->
<form id="conditionsForm" action="/updateConditions" method="post" class="hidden">
    <input type="hidden" name="province" id="f-province">
    <input type="hidden" name="city" id="f-city">
    <input type="hidden" name="gender" id="f-gender">
    <input type="hidden" name="birthDate" id="f-birthDate">

    <input type="hidden" name="eduLevelCode" id="f-eduLevelCode">
    <input type="hidden" name="empStatusCode" id="f-empStatusCode">
    <input type="hidden" name="businessRegistered" id="f-businessRegistered">

    <input type="hidden" name="married" id="f-married">
    <input type="hidden" name="child" id="f-child">
    <input type="hidden" name="home" id="f-home">
    <input type="hidden" name="familySize" id="f-familySize">

    <input type="hidden" name="personalIncome" id="f-personalIncome">
    <input type="hidden" name="familyIncome" id="f-familyIncome">
</form>

<script th:inline="javascript">
    /*<![CDATA[*/

        // 서버 플래시 메시지
        const serverMsg = [[${msg}]];
        if (serverMsg) {
            window.addEventListener('DOMContentLoaded', () => {
                showCustomAlert(serverMsg);
            });
        }

        // ✅ 서버 세션(member) 값들을 JS로 받기
        const serverMember = {
            gender: [[${session.loginMember.gender}]],
            birthDate: [[${session.loginMember.birthDate}]],
            province: [[${session.loginMember.province}]],
            city: [[${session.loginMember.city}]],

            eduLevelCode: [[${session.loginMember.eduLevelCode}]],
            empStatusCode: [[${session.loginMember.empStatusCode}]],
            businessRegistered: [[${session.loginMember.businessRegistered}]],

            married: [[${session.loginMember.married}]],
            child: [[${session.loginMember.child}]],
            home: [[${session.loginMember.home}]],
            familySize: [[${session.loginMember.familySize}]],

            // DB는 원 단위. 화면은 만원 단위로 보여줄거라서 아래에서 변환
            personalIncome: [[${session.loginMember.personalIncome}]],
            familyIncome: [[${session.loginMember.familyIncome}]]
        };

        function showCustomAlert(msg) {
            const modal = document.getElementById('alert-modal');
            const content = document.getElementById('alert-content');
            document.getElementById('alert-msg').innerText = msg;

            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeAlertModal() {
            const modal = document.getElementById('alert-modal');
            const content = document.getElementById('alert-content');

            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function openNameChangeModal() {
            const modal = document.getElementById('name-modal');
            const content = document.getElementById('name-content');
            document.getElementById('newNameInput').value = [[${session.loginMember.memberName}]];

            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);

            setTimeout(() => document.getElementById('newNameInput').focus(), 100);
        }

        function closeNameChangeModal() {
            const modal = document.getElementById('name-modal');
            const content = document.getElementById('name-content');

            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function validateNameChange() {
            const nameInput = document.getElementById('newNameInput');
            if (nameInput.value.trim() === "") {
                showCustomAlert("이름을 입력해주세요.");
                nameInput.focus();
                return false;
            }
            return true;
        }

        const areaData = {
            "서울특별시": ["종로구","중구","용산구","성동구","광진구","동대문구","중랑구","성북구","강북구","도봉구","노원구","은평구","서대문구","마포구","양천구","강서구","구로구","금천구","영등포구","동작구","관악구","서초구","강남구","송파구","강동구"],
            "부산광역시": ["중구","서구","동구","영도구","부산진구","동래구","남구","북구","해운대구","사하구","금정구","강서구","연제구","수영구","사상구","기장군"],
            "대구광역시": ["중구","동구","서구","남구","북구","수성구","달서구","달성군","군위군"],
            "인천광역시": ["중구","동구","미추홀구","연수구","남동구","부평구","계양구","서구","강화군","옹진군"],
            "광주광역시": ["동구","서구","남구","북구","광산구"],
            "대전광역시": ["동구","중구","서구","유성구","대덕구"],
            "울산광역시": ["중구","남구","동구","북구","울주군"],
            "세종특별자치시": ["세종특별자치시"],
            "경기도": ["수원시","성남시","의정부시","안양시","부천시","광명시","평택시","동두천시","안산시","고양시","과천시","구리시","남양주시","오산시","시흥시","군포시","의왕시","하남시","용인시","파주시","이천시","안성시","김포시","화성시","광주시","양주시","포천시","여주시","연천군","가평군","양평군"],
            "강원특별자치도": ["춘천시","원주시","강릉시","동해시","태백시","속초시","삼척시","홍천군","횡성군","영월군","평창군","정선군","철원군","화천군","양구군","인제군","고성군","양양군"],
            "충청북도": ["청주시","충주시","제천시","보은군","옥천군","영동군","증평군","진천군","괴산군","음성군","단양군"],
            "충청남도": ["천안시","공주시","보령시","아산시","서산시","논산시","계룡시","당진시","금산군","부여군","서천군","청양군","홍성군","예산군","태안군"],
            "전북특별자치도": ["전주시","군산시","익산시","정읍시","남원시","김제시","완주군","진안군","무주군","장수군","임실군","순창군","고창군","부안군"],
            "전라남도": ["목포시","여수시","순천시","나주시","광양시","담양군","곡성군","구례군","고흥군","보성군","화순군","장흥군","강진군","해남군","영암군","무안군","함평군","영광군","장성군","완도군","진도군","신안군"],
            "경상북도": ["포항시","경주시","김천시","안동시","구미시","영주시","영천시","상주시","문경시","경산시","의성군","청송군","영양군","영덕군","청도군","고령군","성주군","칠곡군","예천군","봉화군","울진군","울릉군"],
            "경상남도": ["창원시","진주시","통영시","사천시","김해시","밀양시","거제시","양산시","의령군","함안군","창녕군","고성군","남해군","하동군","산청군","함양군","거창군","합천군"],
            "제주특별자치도": ["제주시","서귀포시"]
        };

        document.addEventListener("DOMContentLoaded", function() {
            const siSelect = document.getElementById("modal-regionSi");
            for (const si in areaData) {
                const option = document.createElement("option");
                option.value = si;
                option.text = si;
                siSelect.appendChild(option);
            }

            syncSlider('modal-myIncomeSlider', 'modal-myIncomeText');
            syncSlider('modal-hhIncomeSlider', 'modal-hhIncomeText');

            // ✅ 서버 세션값으로 뷰 채우기
            loadServerConditionsToView();
        });

        function updateModalRegionGu() {
            const siSelect = document.getElementById("modal-regionSi");
            const guSelect = document.getElementById("modal-regionGu");
            const selectedSi = siSelect.value;
            guSelect.innerHTML = '<option value="">시/군/구 선택</option>';

            if (selectedSi && areaData[selectedSi]) {
                areaData[selectedSi].forEach(function(gu) {
                    const option = document.createElement("option");
                    option.value = gu;
                    option.text = gu;
                    guSelect.appendChild(option);
                });
            }
        }

        function syncSlider(sliderId, textId) {
            const slider = document.getElementById(sliderId);
            const text = document.getElementById(textId);

            slider.addEventListener('input', () => text.value = slider.value);
            text.addEventListener('input', () => {
                 let val = parseInt(text.value) || 0;
                 if(val > parseInt(slider.max)) val = slider.max;
                 slider.value = val;
            });
        }

        // ✅ 서버값(원 단위)을 화면(만원)으로 보여주기
        function wonToManwon(won) {
            if (won === null || won === undefined) return 0;
            const n = parseInt(won);
            if (isNaN(n)) return 0;
            return Math.floor(n / 10000);
        }

        function formatBirth(b) {
            if (!b) return '-';
            // "YYYY-MM-DD" 형태가 보통이라 그대로 사용
            return b;
        }

        function loadServerConditionsToView() {
            const gender = (serverMember.gender === 'M') ? '남성' : (serverMember.gender === 'F' ? '여성' : '-');
            const birth = formatBirth(serverMember.birthDate);
            document.getElementById('view-basic').innerText = `${gender} / ${birth}`;

            const region = (serverMember.province || '-') + ' ' + (serverMember.city || '');
            document.getElementById('view-region').innerText = region.trim();

            const eduLabel = eduText(serverMember.eduLevelCode);
            document.getElementById('view-edu').innerText = eduLabel;

            const jobLabel = empText(serverMember.empStatusCode);
            const biz = (serverMember.businessRegistered === true) ? ' (사업자)' : '';
            document.getElementById('view-job').innerText = (jobLabel || '-') + biz;

            const marry = (serverMember.married === true) ? '기혼' : '미혼';
            document.getElementById('view-family').innerText = `${marry} / 자녀 ${(serverMember.child ?? 0)}명`;

            const house = (serverMember.home === true) ? '자가' : '전/월세';
            document.getElementById('view-house').innerText = `${house} / 가구원 ${(serverMember.familySize ?? 1)}명`;

            document.getElementById('view-myIncome').innerText = wonToManwon(serverMember.personalIncome) + '만원';
            document.getElementById('view-hhIncome').innerText = wonToManwon(serverMember.familyIncome) + '만원';
        }

        function eduText(code) {
            switch (parseInt(code)) {
                case 1: return '고졸 미만';
                case 2: return '고등학교 졸업';
                case 3: return '대학교 재학/휴학';
                case 4: return '대학교 졸업(예정)';
                case 5: return '석/박사';
                default: return '-';
            }
        }

        function empText(code) {
            switch (parseInt(code)) {
                case 1: return '미취업';
                case 2: return '직장인';
                case 3: return '자영업/프리랜서';
                case 4: return '학생';
                default: return '-';
            }
        }

        function openSetupModal() {
            const modal = document.getElementById('setup-modal');

            // ✅ 서버값으로 모달 초기화
            setRadio('modal-gender', serverMember.gender);
            setValue('modal-birthDate', serverMember.birthDate);

            setValue('modal-regionSi', serverMember.province);
            updateModalRegionGu();
            setValue('modal-regionGu', serverMember.city);

            setValue('modal-educationLevel', serverMember.eduLevelCode);
            setValue('modal-employmentStatus', serverMember.empStatusCode);

            document.getElementById('modal-bizCheck').checked = (serverMember.businessRegistered === true);

            setRadio('modal-marry', String(serverMember.married === true));
            setValue('modal-childCount', (serverMember.child ?? 0));

            setRadio('modal-house', String(serverMember.home === true));
            setValue('modal-familyCount', (serverMember.familySize ?? 1));

            setSlider('modal-myIncomeSlider', 'modal-myIncomeText', wonToManwon(serverMember.personalIncome));
            setSlider('modal-hhIncomeSlider', 'modal-hhIncomeText', wonToManwon(serverMember.familyIncome));

            modal.classList.remove('hidden');
        }

        function closeSetupModal() {
            document.getElementById('setup-modal').classList.add('hidden');
        }

        function normalizeBirthDate(input) {
            if (!input) return '';
            const v = input.trim();
            // YYYYMMDD -> YYYY-MM-DD
            if (/^\d{8}$/.test(v)) {
                return v.substring(0,4) + "-" + v.substring(4,6) + "-" + v.substring(6,8);
            }
            // YYYY-MM-DD
            if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
            return v; // 일단 그대로 보내고, 필요하면 서버에서 검증
        }

        // ✅ 저장: hidden form 채워서 /updateConditions POST
        function saveConditions() {
            const gender = getRadio('modal-gender');
            const birthDate = normalizeBirthDate(getValue('modal-birthDate'));
            const province = getValue('modal-regionSi');
            const city = getValue('modal-regionGu');

            const eduLevelCode = getValue('modal-educationLevel');
            const empStatusCode = getValue('modal-employmentStatus');
            const businessRegistered = document.getElementById('modal-bizCheck').checked;

            const married = getRadio('modal-marry');
            const child = getValue('modal-childCount');
            const home = getRadio('modal-house');
            const familySize = getValue('modal-familyCount');

            const myIncomeMan = parseInt(getValue('modal-myIncomeText')) || 0;
            const hhIncomeMan = parseInt(getValue('modal-hhIncomeText')) || 0;

            // 화면 입력은 "만원" 단위 → DB는 "원" 단위로 저장
            const personalIncome = myIncomeMan * 10000;
            const familyIncome = hhIncomeMan * 10000;

            // hidden form set
            setHidden('f-province', province);
            setHidden('f-city', city);
            setHidden('f-gender', gender);
            setHidden('f-birthDate', birthDate);

            setHidden('f-eduLevelCode', eduLevelCode);
            setHidden('f-empStatusCode', empStatusCode);
            setHidden('f-businessRegistered', String(businessRegistered));

            setHidden('f-married', married);
            setHidden('f-child', child);
            setHidden('f-home', home);
            setHidden('f-familySize', familySize);

            setHidden('f-personalIncome', String(personalIncome));
            setHidden('f-familyIncome', String(familyIncome));

            document.getElementById('conditionsForm').submit();
        }

        function setHidden(id, val) {
            document.getElementById(id).value = (val === undefined || val === null) ? '' : val;
        }

        function getValue(id) { return document.getElementById(id).value; }
        function setValue(id, val) { if(val !== undefined && val !== null) document.getElementById(id).value = val; }
        function getRadio(name) {
            const el = document.querySelector(`input[name="${name}"]:checked`);
            return el ? el.value : '';
        }
        function setRadio(name, val) {
            if(val === undefined || val === null || val === '') return;
            const el = document.querySelector(`input[name="${name}"][value="${val}"]`);
            if(el) el.checked = true;
        }
        function setSlider(sliderId, textId, val) {
            const v = val || 0;
            document.getElementById(sliderId).value = v;
            document.getElementById(textId).value = v;
        }

        // 비밀번호 유효성 검사 기존 유지
        const newPw = document.getElementById('newPw');
        const newPwConfirm = document.getElementById('newPwConfirm');
        const pwMatchMsg = document.getElementById('pwMatchMsg');
        const pwRuleError = document.getElementById('pwRuleError');

        if (newPw && newPwConfirm) {
            function checkPwValidation() {
                const val = newPw.value;
                const regex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[$@$!%*#?&])[A-Za-z\d$@$!%*#?&]{6,20}$/;
                if(val.length > 0 && !regex.test(val)) {
                    pwRuleError.classList.remove('hidden');
                    newPw.classList.add('border-red-500');
                } else {
                    pwRuleError.classList.add('hidden');
                    newPw.classList.remove('border-red-500');
                }
                checkPasswordMatch();
            }
            function checkPasswordMatch() {
                if (newPwConfirm.value.length === 0) {
                    pwMatchMsg.classList.add('hidden');
                    newPwConfirm.classList.remove('border-red-500');
                    return;
                }
                if (newPw.value !== newPwConfirm.value) {
                    pwMatchMsg.classList.remove('hidden');
                    newPwConfirm.classList.add('border-red-500');
                } else {
                    pwMatchMsg.classList.add('hidden');
                    newPwConfirm.classList.remove('border-red-500');
                }
            }
            newPw.addEventListener('input', checkPwValidation);
            newPwConfirm.addEventListener('input', checkPasswordMatch);
        }

        function validateForm() {
            if(newPw && newPw.value.length > 0) {
                const regex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[$@$!%*#?&])[A-Za-z\d$@$!%*#?&]{6,20}$/;
                if (!regex.test(newPw.value)) {
                    showCustomAlert('비밀번호 형식이 올바르지 않습니다.');
                    newPw.focus();
                    return false;
                }
                if(newPw.value !== newPwConfirm.value) {
                    showCustomAlert('새 비밀번호가 일치하지 않습니다.');
                    newPwConfirm.focus();
                    return false;
                }
                const currentPw = document.querySelector('input[name="currentPw"]');
                if(currentPw && currentPw.value.length === 0) {
                    showCustomAlert('비밀번호를 변경하려면 기존 비밀번호를 입력해야 합니다.');
                    currentPw.focus();
                    return false;
                }
            }
            return true;
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                closeSetupModal();
                closeAlertModal();
                closeNameChangeModal();
            }
        });

    /*]]>*/
</script>

</body>
</html>
