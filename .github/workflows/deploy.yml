name: Deploy to Google Cloud

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 1. μλ°” 21 μ„Έν… (μ‚¬μ©μλ‹ ν”„λ΅μ νΈ JDK 21 μ‚¬μ© μ¤‘)
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 2. λΉλ“ (ν…μ¤νΈλ” κ±΄λ„λ›°κ³  λΉ λ¥΄κ² jar μƒμ„±)
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean bootJar -x test

      # 3. μ„λ²„λ΅ νμΌ μ „μ†΅ (SCP)
      - name: Copy Jar to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USERNAME }}
          key: ${{ secrets.GCP_SSH_KEY }}
          source: "./build/libs/*.jar"
          target: "/home/${{ secrets.GCP_USERNAME }}/app"
          strip_components: 2 # κ²½λ΅ λ–Όκ³  νμΌλ§ μ „μ†΅

      # 4. μ„λ²„μ—μ„ μ‹¤ν–‰ (μµμ ν™” λ²„μ „)
      - name: Deploy on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USERNAME }}
          key: ${{ secrets.GCP_SSH_KEY }}
          script: |
            # 1. κΈ°μ΅΄ μ„λ²„ μΆ…λ£ λ° λ©”λ¨λ¦¬ μ •λ¦¬
            echo "Stopping existing application..."
            sudo pkill -9 -f 'java -jar' || true
            
            # 2. λ©”λ¨λ¦¬ λΉ„μ°κΈ° (λ¦¬λ…μ¤ μ»¤λ„ μΊμ‹ λΉ„μ°κΈ° - λ©”λ¨λ¦¬ ν™•λ³΄ ν•„μ‚΄κΈ°)
            sudo sync && echo 3 | sudo tee /proc/sys/vm/drop_caches
            
            # 3. μ•± ν΄λ” μ •λ¦¬ (μ΄μ „ λ²„μ „ νμΌ μ‚­μ )
            mkdir -p /home/${{ secrets.GCP_USERNAME }}/app
            rm -f /home/${{ secrets.GCP_USERNAME }}/app/*.jar.old
            
            # 4. μƒ μ„λ²„ μ‹¤ν–‰ (λ©”λ¨λ¦¬ μ ν•μ„ λ” νƒ€μ΄νΈν•κ² 256MBλ΅ μ„¤μ •)
            # ν„μ¬ 8GB λ©”λ¨λ¦¬κ°€ μμ§€λ§, μ‹μ¤ν… μ•μ •μ„±μ„ μ„ν•΄ μ‘κ² μ‹μ‘ν•΄λ΄…λ‹λ‹¤.
            echo "Starting new application..."
            nohup java -Xms256m -Xmx256m -jar /home/${{ secrets.GCP_USERNAME }}/app/*.jar > /home/${{ secrets.GCP_USERNAME }}/nohup.out 2>&1 &
            
            # 5. μ‹¤ν–‰ μ—¬λ¶€ ν™•μΈ
            sleep 5
            if pgrep -f 'java -jar' > /dev/null
            then
              echo "π€ λ°°ν¬ μ„±κ³µ! μ„λ²„κ°€ μ •μƒ μ‹¤ν–‰ μ¤‘μ…λ‹λ‹¤."
            else
              echo "β λ°°ν¬ μ‹¤ν¨! λ΅κ·Έ(nohup.out)λ¥Ό ν™•μΈν•μ„Έμ”."
              exit 1
            fi